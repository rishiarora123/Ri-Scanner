{% extends "base.html" %}

{% block title %}New Scan - Ri-Scanner Pro{% endblock %}

{% block content %}
<div class="text-center mb-lg" style="margin-bottom: 3rem;">
    <h1 class="gradient-text" style="font-size: 3rem; margin-bottom: 0.5rem;">üîç Start New Scan</h1>
    <p class="text-muted" style="font-size: 1.2rem;">Choose a scanning method to discover websites and servers</p>
</div>

<div class="grid-3">
    <!-- Full Recon Card -->
    <div class="glass card">
        <div class="card-header">
            <h2 style="color: #60a5fa;">1. Deep Infra Analysis</h2>
            <p class="card-description">Discovers subdomains, extracts ASNs, and scans infrastructure for open services.
            </p>
            <small style="display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">Technical:
                Subdomains (Chaos/Subfinder) ‚Üí ASN Extraction ‚Üí Port Scanning (Masscan/Naabu)</small>
        </div>
        <form id="form-recon" onsubmit="startScan(event, 'recon', this)">
            <div class="form-group">
                <label class="form-label">Target Domain <span class="help-icon"
                        title="Enter any website domain without http:// or www">‚ÑπÔ∏è</span></label>
                <input type="text" name="domain" class="form-input" placeholder="example.com">
                <small class="form-help">Example: google.com, facebook.com</small>
            </div>

            <div
                style="text-align: center; margin: 1rem 0; color: var(--text-muted); font-weight: 600; position: relative;">
                <span style="background: var(--glass-bg); padding: 0 1rem; position: relative; z-index: 1;">OR</span>
                <div
                    style="position: absolute; top: 50%; left: 0; right: 0; border-top: 1px solid var(--glass-border); z-index: 0;">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Upload IP Range File <span class="help-icon"
                        title="Directly scan these IP ranges/CIDRs. Discovery will be skipped.">‚ÑπÔ∏è</span></label>
                <input type="file" name="ip_file" class="form-input">
                <small class="form-help">Format: .txt (one range per line)</small>
            </div>

            <div class="form-group">
                <label class="form-label">Scan Speed</label>
                <select name="scan_speed" class="form-input">
                    <option value="slow">üê¢ Slow & Stealthy</option>
                    <option value="balanced" selected>‚öñÔ∏è Balanced (Recommended)</option>
                    <option value="fast">‚ö° Fast</option>
                    <option value="insane">üöÄ Insane (Max Rate)</option>
                </select>
            </div>

            <!-- Tool Selection -->
            <div class="form-group">
                <label class="form-label">
                    Discovery Tools
                    <span class="help-icon" title="Select which tools to use for subdomain discovery">‚ÑπÔ∏è</span>
                </label>
                <div id="tool-selection-panel"
                    style="margin-top: 0.75rem; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: var(--radius-md); border: 1px solid var(--glass-border);">
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem;">
                        <label class="tool-checkbox"><input type="checkbox" name="tools" value="subfinder" checked>
                            Subfinder</label>
                        <label class="tool-checkbox"><input type="checkbox" name="tools" value="assetfinder" checked>
                            Assetfinder</label>
                        <label class="tool-checkbox"><input type="checkbox" name="tools" value="chaos" checked>
                            Chaos</label>
                    </div>
                    <small style="display: block; margin-top: 0.75rem; color: var(--text-muted);">Highly optimized for
                        deep infrastructure enumeration.</small>
                </div>
                <input type="hidden" id="selected-tools" name="selected_tools" value="">
            </div>

            <div class="form-group">
                <label class="form-label">Masscan Rate (packets/sec) <span class="help-icon"
                        title="Packets per second for masscan tool">‚ÑπÔ∏è</span></label>
                <input type="number" name="masscan_rate" class="form-input" value="10000" min="100" max="100000"
                    placeholder="Default: 10000">
                <small class="form-help">Controls scanning intensity (100-100000)</small>
            </div>

            <div class="form-group">
                <label class="form-label">Ports to Scan <span class="help-icon"
                        title="Comma-separated ports. 80,443 use standard engine. 27017 uses specialized Netcat check.">‚ÑπÔ∏è</span></label>
                <input type="text" name="ports" class="form-input" value="80, 443">
                <small class="form-help">Default: 80, 443. Example: 80, 443, 27017</small>
            </div>

            <div class="form-group">
                <label class="form-label">Scan Threads <span class="help-icon"
                        title="Number of parallel threads/chunks for Masscan and Naabu. Higher = Faster but uses more CPU.">‚ÑπÔ∏è</span></label>
                <input type="number" name="threads" class="form-input" value="10" min="1" max="100"
                    placeholder="Recommended: 10">
                <small class="form-help">Parallel execution threads (1-100)</small>
            </div>

            <button type="submit" class="btn btn-secondary btn-full">
                <span class="btn-text">Launch Recon</span>
                <span class="spinner hidden"></span>
            </button>
        </form>
    </div>

    <!-- ASN List Card -->
    <div class="glass card">
        <div class="card-header">
            <h2 style="color: #a855f7;">2. From ASN List</h2>
            <p class="card-description">Input a list of ASNs (e.g. AS15169). Will resolve them to IP ranges and scan.
            </p>
        </div>
        <form id="form-asn" onsubmit="startScan(event, 'asn_list', this)">
            <div class="form-group">
                <label class="form-label">ASN List</label>
                <textarea name="asns" class="form-input" placeholder="AS15169, AS16509"
                    style="height: 100px; resize: vertical;" required></textarea>
                <small class="form-help">Comma or space separated ASNs</small>
            </div>

            <div class="form-group">
                <label class="form-label">Scan Speed</label>
                <select name="scan_speed" class="form-input">
                    <option value="slow">üê¢ Slow & Stealthy</option>
                    <option value="balanced" selected>‚öñÔ∏è Balanced (Recommended)</option>
                    <option value="fast">‚ö° Fast</option>
                    <option value="insane">üöÄ Insane (Max Rate)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Masscan Rate (packets/sec)</label>
                <input type="number" name="masscan_rate" class="form-input" value="10000" min="100" max="100000">
            </div>

            <div class="form-group">
                <label class="form-label">Ports to Scan</label>
                <input type="text" name="ports" class="form-input" value="80, 443">
                <small class="form-help">Example: 80, 443, 27017</small>
            </div>

            <div class="form-group">
                <label class="form-label">Scan Threads <span class="help-icon"
                        title="Number of parallel threads/chunks for Masscan and Naabu. Higher = Faster but uses more CPU.">‚ÑπÔ∏è</span></label>
                <input type="number" name="threads" class="form-input" value="10" min="1" max="100">
                <small class="form-help">Parallel execution threads (1-100)</small>
            </div>

            <button type="submit" class="btn btn-full" style="background: var(--accent); color: white;">
                <span class="btn-text">Start ASN Scan</span>
                <span class="spinner hidden"></span>
            </button>
        </form>
    </div>
</div>

<!-- Analysis Workflow Section -->
<div class="glass card mt-lg" style="margin-top: 2rem;">
    <div class="card-header text-center">
        <h2 style="color: var(--primary);">üõ†Ô∏è How Deep Infra Analysis Works</h2>
        <p class="card-description">
            A high-speed, systematic approach to mapping an organization's perimeter.
        </p>
    </div>

    <div class="grid-3" style="padding: 1rem;">
        <div class="stat-card">
            <div class="stat-value" style="font-size: 1.5rem;">üîç</div>
            <div class="stat-label">1. Discovery</div>
            <div class="text-muted" style="font-size: 0.8rem;">Enumerates subdomains using Chaos, Subfinder, and
                Assetfinder for maximum coverage.</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="font-size: 1.5rem;">üåè</div>
            <div class="stat-label">2. IP Resolution</div>
            <div class="text-muted" style="font-size: 0.8rem;">Maps subdomains to IPs, identifies unique ASNs, and
                resolves them to full IP prefixes.</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="font-size: 1.5rem;">üì°</div>
            <div class="stat-label">3. Infra Scan</div>
            <div class="text-muted" style="font-size: 0.8rem;">Runs Masscan and Naabu in parallel to identify active
                services on ports 80 and 443.</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .tool-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: background var(--transition-fast);
        font-size: 0.85rem;
    }

    .tool-checkbox:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    .tool-checkbox input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
    }
</style>
<script>
    // Tool Selection Functions
    function getSelectedTools() {
        const selected = [];
        document.querySelectorAll('#tool-selection-panel input[type="checkbox"]:checked').forEach(cb => {
            selected.push(cb.value);
        });
        return selected;
    }

    async function startScan(e, mode, form) {
        e.preventDefault();
        const formData = new FormData(form);
        formData.append('mode', mode);

        // Collect selected tools for recon mode
        if (mode === 'recon') {
            const selectedTools = getSelectedTools();
            if (selectedTools.length > 0) {
                formData.set('selected_tools', selectedTools.join(','));
            }
        }

        const btn = form.querySelector('button[type="submit"]');
        const btnText = btn.querySelector('.btn-text');
        const spinner = btn.querySelector('.spinner');
        const originalText = btnText.innerText;

        btnText.innerText = 'Starting...';
        spinner.classList.remove('hidden');
        btn.disabled = true;

        try {
            const res = await fetch('/start_scan', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.status === 'started') {
                window.location.href = '/dashboard';
            } else {
                alert('Error: ' + JSON.stringify(data));
                resetButton();
            }
        } catch (err) {
            alert('Request Failed: ' + err);
            resetButton();
        }

        function resetButton() {
            btnText.innerText = originalText;
            spinner.classList.add('hidden');
            btn.disabled = false;
        }
    }
</script>
{% endblock %}