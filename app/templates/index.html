{% extends "base.html" %}

{% block title %}New Scan - Ri-Scanner Pro{% endblock %}

{% block content %}
<div class="text-center mb-lg" style="margin-bottom: 3rem;">
    <h1 class="gradient-text" style="font-size: 3rem; margin-bottom: 0.5rem;">Start Your Recon</h1>
    <p class="text-muted" style="font-size: 1.2rem;">Select a method to acquire targets and identify hidden
        infrastructure.</p>
</div>

<div class="grid-3">
    <!-- Full Recon Card -->
    <div class="glass card">
        <div class="card-header">
            <h2 style="color: #60a5fa;">1. Full Recon</h2>
            <p class="card-description">Subdomain discovery ‚Üí IP Resolution ‚Üí ASN Expansion ‚Üí Masscan ‚Üí Content
                Discovery.</p>
        </div>
        <form id="form-recon" onsubmit="startScan(event, 'recon', this)">
            <div class="form-group">
                <label class="form-label">Target Domain</label>
                <input type="text" name="domain" class="form-input" placeholder="example.com" required>
            </div>

            <div class="form-group">
                <label class="form-label">BGP URL (Optional)</label>
                <input type="text" name="bgp_url" class="form-input" placeholder="bgp.he.net/...">
            </div>

            <div class="form-group">
                <label class="form-label">Masscan Rate</label>
                <input type="number" name="masscan_rate" class="form-input" value="10000">
            </div>

            <div class="form-group">
                <label class="form-label">Chunks (0=Auto)</label>
                <input type="number" name="masscan_chunks" class="form-input" value="0">
            </div>

            <button type="submit" class="btn btn-secondary btn-full">
                <span class="btn-text">Launch Recon</span>
                <span class="spinner hidden"></span>
            </button>
        </form>
    </div>

    <!-- Masscan Result Card -->
    <div class="glass card">
        <div class="card-header">
            <h2 style="color: #34d399;">2. From Masscan Result</h2>
            <p class="card-description">Upload an existing masscan result file (-oH format) to extract domains.</p>
        </div>
        <form id="form-masscan" onsubmit="startScan(event, 'masscan_file', this)">
            <div class="form-group">
                <label class="form-label">Masscan Result File</label>
                <input type="file" name="file" class="form-input" required>
            </div>

            <button type="submit" class="btn btn-success btn-full mt-lg">
                <span class="btn-text">Process Results</span>
                <span class="spinner hidden"></span>
            </button>
        </form>
    </div>

    <!-- IP List Card -->
    <div class="glass card">
        <div class="card-header">
            <h2 style="color: #fbbf24;">3. From IP List</h2>
            <p class="card-description">Upload a list of IP ranges or CIDRs. Will run Masscan then Extract.</p>
        </div>
        <form id="form-ip" onsubmit="startScan(event, 'ip_file', this)">
            <div class="form-group">
                <label class="form-label">IP Range File</label>
                <input type="file" name="file" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label">Masscan Rate</label>
                <input type="number" name="masscan_rate" class="form-input" value="10000">
            </div>

            <div class="form-group">
                <label class="form-label">Chunks (0=Auto)</label>
                <input type="number" name="masscan_chunks" class="form-input" value="0">
            </div>

            <button type="submit" class="btn btn-warning btn-full">
                <span class="btn-text">Start Scan</span>
                <span class="spinner hidden"></span>
            </button>
        </form>
    </div>

    <!-- ASN List Card -->
    <div class="glass card">
        <div class="card-header">
            <h2 style="color: #a855f7;">4. From ASN List</h2>
            <p class="card-description">Input a list of ASNs (e.g. AS15169). Will resolve to IPs then scan.</p>
        </div>
        <form id="form-asn" onsubmit="startScan(event, 'asn_list', this)">
            <div class="form-group">
                <label class="form-label">ASN List (Comma or Space separated)</label>
                <textarea name="asns" class="form-input" placeholder="AS15169, AS16509"
                    style="height: 100px; resize: vertical;" required></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Masscan Rate</label>
                <input type="number" name="masscan_rate" class="form-input" value="10000">
            </div>

            <div class="form-group">
                <label class="form-label">Chunks (0=Auto)</label>
                <input type="number" name="masscan_chunks" class="form-input" value="0">
            </div>

            <button type="submit" class="btn btn-full" style="background: var(--accent); color: white;">
                <span class="btn-text">Start ASN Scan</span>
                <span class="spinner hidden"></span>
            </button>
        </form>
    </div>
</div>

<!-- Recon Tools Overview Section -->
<div class="glass card mt-lg" style="margin-top: 2rem;">
    <div class="card-header text-center">
        <h2 style="color: var(--primary);">üß∞ Recon Tools Available</h2>
        <p class="card-description">
            40+ reconnaissance tools integrated for comprehensive scanning.
            <a href="/settings" style="color: var(--primary);">Configure API keys & view status ‚Üí</a>
        </p>
    </div>

    <div class="grid-3" style="padding: 1rem;">
        <div class="stat-card">
            <div class="stat-value" style="font-size: 1.5rem;">üîç</div>
            <div class="stat-label">Subdomain Tools</div>
            <div class="text-muted" style="font-size: 0.8rem;">Subfinder, Amass, Chaos, DNSx, +9 more</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="font-size: 1.5rem;">üõ∞Ô∏è</div>
            <div class="stat-label">Search Engines</div>
            <div class="text-muted" style="font-size: 0.8rem;">Shodan, Censys, ZoomEye, FOFA, SecurityTrails</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="font-size: 1.5rem;">üåê</div>
            <div class="stat-label">CT Logs</div>
            <div class="text-muted" style="font-size: 0.8rem;">crt.sh, Certspotter, Bufferover</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="font-size: 1.5rem;">üåç</div>
            <div class="stat-label">Origin IP Discovery</div>
            <div class="text-muted" style="font-size: 0.8rem;">CloudFlair, CloudFail, DNSRecon</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="font-size: 1.5rem;">üîó</div>
            <div class="stat-label">URL Discovery</div>
            <div class="text-muted" style="font-size: 0.8rem;">Waybackurls, GAU, Katana, Hakrawler</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="font-size: 1.5rem;">üß∞</div>
            <div class="stat-label">Frameworks</div>
            <div class="text-muted" style="font-size: 0.8rem;">Recon-ng, Osmedeus, Sn1per, Aquatone</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function startScan(e, mode, form) {
        e.preventDefault();
        const formData = new FormData(form);
        formData.append('mode', mode);

        const btn = form.querySelector('button');
        const btnText = btn.querySelector('.btn-text');
        const spinner = btn.querySelector('.spinner');
        const originalText = btnText.innerText;

        btnText.innerText = 'Starting...';
        spinner.classList.remove('hidden');
        btn.disabled = true;

        try {
            const res = await fetch('/start_scan', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.status === 'started') {
                window.location.href = '/dashboard';
            } else {
                alert('Error: ' + JSON.stringify(data));
                resetButton();
            }
        } catch (err) {
            alert('Request Failed: ' + err);
            resetButton();
        }

        function resetButton() {
            btnText.innerText = originalText;
            spinner.classList.add('hidden');
            btn.disabled = false;
        }
    }
</script>
{% endblock %}