{% extends "base.html" %}

{% block title %}Subdomains - Ri-Scanner Pro{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="text-center mb-lg">
        <h1 class="gradient-text">üåê Discovered Websites & Subdomains</h1>
        <p class="text-muted" style="font-size: 1.1rem;">
            All websites and subdomains found across all your scans
        </p>

        <!-- Auto-Scan Status -->
        <div id="job-status"
            style="margin-top: 1rem; display: inline-block; background: rgba(59, 130, 246, 0.1); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid rgba(59, 130, 246, 0.3); font-size: 0.9rem;">
            <span class="spinner"
                style="width: 12px; height: 12px; border-width: 2px; vertical-align: middle; margin-right: 0.5rem;"></span>
            Auto-Scanning: <span id="job-running" style="font-weight: bold; color: var(--primary);">0</span> running,
            <span id="job-queued" style="font-weight: bold;">0</span> pending
        </div>
    </div>

    <!-- Controls Bar -->
    <div class="glass card mb-md">
        <div class="flex-between" style="gap: 1rem; flex-wrap: wrap;">
            <!-- Search -->
            <div style="flex: 1; min-width: 300px;">
                <div class="search-container">
                    <input type="text" id="subdomain-search" class="form-input"
                        placeholder="üîç Search websites (e.g., google.com, api, login...)"
                        style="padding-right: 2.5rem;">
                    <button onclick="clearSearch()" class="clear-search"
                        style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;">√ó</button>
                </div>
            </div>

            <!-- Filters & Actions -->
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button onclick="toggleFilters()" class="btn btn-outline" id="filter-toggle-btn">
                    üéöÔ∏è Filters <span id="filter-count" class="badge badge-info" style="margin-left: 0.25rem;">0</span>
                </button>
                <button onclick="toggleAutoRefresh()" class="btn btn-outline" id="auto-refresh-btn">
                    ‚è∏Ô∏è Auto Refresh
                </button>
                <button onclick="exportSubdomains()" class="btn btn-outline">
                    üì• Export
                </button>
                <button onclick="refreshSubdomains()" class="btn btn-primary">
                    üîÑ Refresh Now
                </button>
            </div>
        </div>

        <!-- Filter Panel (Collapsible) -->
        <div id="filter-panel" class="hidden"
            style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--glass-border);">
            <div class="grid-4" style="gap: 1rem;">
                <!-- Status Code Filter -->
                <div>
                    <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Response Status</label>
                    <select id="filter-status" class="form-input" onchange="applyFilters()">
                        <option value="">All Statuses</option>
                        <option value="200">‚úÖ 200 - OK</option>
                        <option value="301">‚Ü™Ô∏è 301 - Redirect</option>
                        <option value="302">‚Ü™Ô∏è 302 - Redirect</option>
                        <option value="403">üö´ 403 - Forbidden</option>
                        <option value="404">‚ùå 404 - Not Found</option>
                        <option value="500">‚ö†Ô∏è 500 - Server Error</option>
                    </select>
                </div>

                <!-- Source Filter -->
                <div>
                    <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Discovery Method</label>
                    <select id="filter-source" class="form-input" onchange="applyFilters()">
                        <option value="">All Sources</option>
                        <option value="recon">üîç Full Scan</option>
                        <option value="asn">üè¢ Network Scan</option>
                        <option value="extraction">üìä Port Scanner</option>
                        <option value="manual">‚úèÔ∏è Manual</option>
                    </select>
                </div>

                <!-- Has Website Filter -->
                <div>
                    <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Website Status</label>
                    <select id="filter-has-site" class="form-input" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="yes">Has Website</option>
                        <option value="no">No Website</option>
                    </select>
                </div>

                <!-- Sort By -->
                <div>
                    <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Sort By</label>
                    <select id="sort-by" class="form-input" onchange="applyFilters()">
                        <option value="newest">üïê Newest First</option>
                        <option value="oldest">üïí Oldest First</option>
                        <option value="domain">üî§ Domain A-Z</option>
                        <option value="status">üìä Status Code</option>
                    </select>
                </div>

                <!-- Http Text Filter -->
                <div>
                    <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Http Text Search</label>
                    <input type="text" id="filter-http-text" class="form-input" placeholder="Search in page content..."
                        onchange="applyFilters()">
                </div>
            </div>

            <div style="margin-top: 1rem; text-align: right;">
                <button onclick="clearFilters()" class="btn btn-outline" style="font-size: 0.85rem;">
                    Clear All Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="stat-grid mb-md">
        <div class="stat-card">
            <div id="stat-total" class="stat-value">0</div>
            <div class="stat-label">Total Subdomains</div>
        </div>
        <div class="stat-card">
            <div id="stat-active" class="stat-value">0</div>
            <div class="stat-label">Active Websites</div>
        </div>
        <div class="stat-card">
            <div id="stat-unique-ips" class="stat-value">N/A</div>
            <div class="stat-label">Unique Servers</div>
        </div>
        <div class="stat-card">
            <div id="stat-tech-detected" class="stat-value">N/A</div>
            <div class="stat-label">Technologies Found</div>
        </div>
    </div>

    <!-- Subdomains List -->
    <div class="glass card">
        <div class="flex-between mb-md">
            <h2 style="margin: 0;">üìã Subdomain List</h2>
            <div id="showing-count" style="font-size: 0.9rem; color: var(--text-muted);">
                Showing 0 results
            </div>
        </div>

        <div id="subdomains-container">
            <div class="text-center" style="padding: 3rem; color: var(--text-muted);">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <p>Loading websites...</p>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="hidden" style="margin-top: 1.5rem; text-align: center;">
            <button onclick="prevPage()" id="prev-btn" class="btn btn-outline">‚Üê Previous</button>
            <span id="page-info" style="margin: 0 1rem; color: var(--text-muted);">Page 1 of 1</span>
            <button onclick="nextPage()" id="next-btn" class="btn btn-outline">Next ‚Üí</button>
        </div>
    </div>
</div>

<!-- Subdomain Detail Modal -->
<div id="subdomain-detail-modal" class="subdomain-modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <div>
                <h2 id="modal-title" style="margin: 0 0 0.25rem 0; font-size: 1.8rem;">Subdomain Details</h2>
                <p id="modal-subtitle" style="margin: 0; color: #9ca3af; font-size: 0.9rem;">Loading...</p>
            </div>
            <button class="btn btn-outline" onclick="closeDetailModal()"
                style="padding: 0.5rem 1rem; font-size: 1.2rem; width: auto;">‚úï Close</button>
        </div>
        <div class="modal-body" id="modal-detail-body">
            <div class="text-center" style="padding: 3rem;">
                <div class="spinner"></div>
                <p>Loading details...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .result-card {
        padding: 1.25rem;
        margin-bottom: 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--radius-md);
        border-left: 4px solid var(--primary);
        cursor: pointer;
        transition: all var(--transition-fast);
        position: relative;
    }

    .result-card:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .result-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .result-url {
        font-size: 0.9rem;
        color: var(--primary);
        word-break: break-all;
        margin-bottom: 0.75rem;
        font-family: 'JetBrains Mono', monospace;
    }

    .result-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
        background: rgba(0, 0, 0, 0.2);
        padding: 0.75rem;
        border-radius: 6px;
    }

    .tech-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 4px;
        font-size: 0.7rem;
        color: #60a5fa;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }

    .status-badge-200 {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success);
    }

    .status-badge-301,
    .status-badge-302 {
        background: rgba(59, 130, 246, 0.2);
        color: var(--secondary);
    }

    .status-badge-403,
    .status-badge-404 {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger);
    }

    .status-badge-500 {
        background: rgba(245, 158, 11, 0.2);
        color: var(--warning);
    }

    .subdomain-modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(17, 24, 39, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
        backdrop-filter: blur(16px);
        flex-direction: column;
        overflow: hidden;
    }

    .subdomain-modal.active {
        display: flex !important;
    }

    .modal-content {
        background: transparent;
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100vh;
        border: none;
        border-radius: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 2rem;
        border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        flex-shrink: 0;
    }

    .modal-body {
        padding: 2rem;
        flex: 1;
        overflow-y: auto;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 2rem;
        color: var(--text-muted);
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
    }

    .close-btn:hover {
        color: var(--text-primary);
    }

    .search-container {
        position: relative;
    }

    .hidden {
        display: none !important;
    }

    .detail-tabs {
        display: flex;
        gap: 0.5rem;
        padding: 0 2rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        overflow-x: auto;
        margin-bottom: 2rem;
    }

    .detail-tab {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all var(--transition-fast);
        padding: 0.75rem 1rem;
        /* Added this back from original .detail-tab */
    }

    .detail-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .detail-tab:hover {
        color: var(--text-primary);
    }

    /* Fuzzing Results */
    .fuzz-result-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 1rem;
    }

    .fuzz-result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 4px;
        border-left: 3px solid transparent;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
    }

    .fuzz-result-item:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    .fuzz-status-200 {
        border-left-color: var(--success);
    }

    .fuzz-status-301 {
        border-left-color: var(--secondary);
    }

    .fuzz-status-403 {
        border-left-color: var(--danger);
    }

    .fuzz-status-500 {
        border-left-color: var(--warning);
    }

    /* Fuzzing Results Styling */
    .fuzz-result-item {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
    }

    .fuzz-result-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
        transform: translateX(4px);
    }

    .fuzz-status-200 {
        border-left: 3px solid #34d399 !important;
    }

    .fuzz-status-301,
    .fuzz-status-302 {
        border-left: 3px solid #60a5fa !important;
    }

    .fuzz-status-403 {
        border-left: 3px solid #ef4444 !important;
    }

    .fuzz-badge {
        font-size: 0.7rem;
        padding: 0.1rem 0.5rem;
        border-radius: 4px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .fuzz-badge-200 {
        background: rgba(52, 211, 153, 0.1);
        color: #34d399;
    }

    .fuzz-badge-30x {
        background: rgba(96, 165, 250, 0.1);
        color: #60a5fa;
    }

    .fuzz-badge-403 {
        background: rgba(239, 68, 68, 0.1);
        color: #f87171;
    }
</style>

<script>
    // State
    let currentPage = 1;
    let totalPages = 1;
    let totalItems = 0;
    const perPage = 20;
    let autoRefreshInterval = null;
    let currentScanId = 'all';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadSubdomains(1);
        setupSearchListener();
        pollJobStatus();
        setInterval(pollJobStatus, 3000); // Poll every 3s
    });

    // Poll Job Status
    async function pollJobStatus() {
        try {
            const res = await fetch('/jobs/status');
            const data = await res.json();

            document.getElementById('job-running').innerText = data.running;
            document.getElementById('job-queued').innerText = data.queued;

            const statusDiv = document.getElementById('job-status');
            if (data.running === 0 && data.queued === 0) {
                statusDiv.style.opacity = '0.5';
                statusDiv.querySelector('.spinner').style.display = 'none';
            } else {
                statusDiv.style.opacity = '1';
                statusDiv.querySelector('.spinner').style.display = 'inline-block';
            }
        } catch (e) {
            console.error("Status poll error", e);
        }
    }

    // Setup search listener with debounce
    function setupSearchListener() {
        const searchInput = document.getElementById('subdomain-search');
        let timeout = null;

        searchInput.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                applyFilters();
            }, 500); // 500ms debounce
        });
    }

    // Load subdomains from server (paginated)
    async function loadSubdomains(page = 1) {
        currentPage = page;

        // Collect filters
        const search = document.getElementById('subdomain-search').value;
        const status = document.getElementById('filter-status').value;
        const source = document.getElementById('filter-source').value;
        const hasSite = document.getElementById('filter-has-site').value;
        const sortBy = document.getElementById('sort-by').value;
        const httpText = document.getElementById('filter-http-text').value;

        // Show loading
        const container = document.getElementById('subdomains-container');
        if (page === 1) { // Only clear container on full reload/search, not necessarily page change but cleaner
            container.innerHTML = `
                <div class="text-center" style="padding: 3rem; color: var(--text-muted);">
                    <div class="spinner" style="margin: 0 auto 1rem;"></div>
                    <p>Loading websites...</p>
                </div>
            `;
        }

        try {
            // Build URL
            const params = new URLSearchParams({
                page: page,
                per_page: perPage,
                search: search,
                status: status,
                source: source,
                has_site: hasSite,
                sort_by: sortBy,
                http_text: httpText
            });

            const res = await fetch(`/subdomains/list/${currentScanId}?${params.toString()}`);
            const data = await res.json();

            if (data.success) {
                renderSubdomains(data.subdomains);

                // Update pagination state
                totalItems = data.total;
                totalPages = data.pages;
                currentPage = data.page;

                updatePaginationControls();
                updateStats(totalItems); // Simply update total count for now
                updateFilterCount();
            } else {
                showError('Failed to load subdomains');
            }
        } catch (err) {
            showError('Error: ' + err.message);
        }
    }

    // Apply filters -> simply reload page 1 with new params
    function applyFilters() {
        loadSubdomains(1);
    }

    // Render subdomains list
    function renderSubdomains(subdomains) {
        const container = document.getElementById('subdomains-container');

        if (!subdomains || subdomains.length === 0) {
            container.innerHTML = `
                <div class="text-center" style="padding: 3rem; color: var(--text-muted);">
                    <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">üîç</p>
                    <p>No websites found matching your filters</p>
                    <p style="font-size: 0.85rem;">Try clearing filters or starting a new scan</p>
                </div>
            `;
            return;
        }

        container.innerHTML = subdomains.map(sub => createSubdomainCard(sub)).join('');
    }

    // Create subdomain card HTML
    function createSubdomainCard(sub) {
        const statusCode = sub.status_code || sub.http_intelligence?.status_code || '---';
        const ip = sub.primary_ip || sub.ip || '---';
        const source = getSourceLabel(sub.source);
        const techs = sub.technologies || [];

        return `
            <div class="result-card" onclick="viewSubdomainDetails('${sub.domain}')">
                <div class="result-title">
                    <span class="tag ${statusCode >= 200 && statusCode < 400 ? 'tag-tech' : 'tag-danger'}" style="margin-right: 0.5rem;">
                        ${statusCode}
                    </span>
                    ${sub.domain}
                    <span class="batch-badge" style="font-size: 0.7rem; opacity: 0.7;">via ${source}</span>
                </div>
                
                <div style="margin-bottom: 0.5rem;">
                    ${techs.slice(0, 8).map(t => `<span class="tech-badge">${t}</span>`).join('')}
                    ${techs.length > 8 ? `<span class="tech-badge" style="opacity: 0.6;">+${techs.length - 8} more</span>` : ''}
                </div>

                <div class="result-url">
                    <a href="https://${sub.domain}" target="_blank" onclick="event.stopPropagation()" style="color: var(--primary); text-decoration: underline;">https://${sub.domain}</a>
                </div>

                <div class="result-meta">
                    <div><strong>IP Address:</strong> ${ip}</div>
                    <div><strong>Discovery:</strong> ${source}</div>
                    <div><strong>Captured:</strong> ${new Date(sub.timestamp || Date.now()).toLocaleDateString()}</div>
                </div>
            </div>
        `;
    }

    // Get source label
    function getSourceLabel(source) {
        const labels = {
            'recon': 'Full Scan',
            'asn': 'Network Scan',
            'extraction': 'Port Scanner',
            'manual': 'Manual'
        };
        return labels[source] || source;
    }

    // View subdomain details
    async function viewSubdomainDetails(domain) {
        const modal = document.getElementById('subdomain-detail-modal');
        const modalBody = document.getElementById('modal-detail-body');
        const modalTitle = document.getElementById('modal-title');

        currentDetailDomain = domain;
        modalTitle.innerText = domain;
        modal.classList.add('active');
        document.body.classList.add('modal-open');

        modalBody.innerHTML = '<div class="text-center" style="padding: 3rem;"><div class="spinner"></div><p>Loading details...</p></div>';

        try {
            const res = await fetch(`/subdomains/details/${currentScanId}/${encodeURIComponent(domain)}`);
            const data = await res.json();

            if (data.success && data.details) {
                renderSubdomainDetails(data.details);
            } else {
                modalBody.innerHTML = '<div style="color: var(--danger); padding: 2rem;">Failed to load details</div>';
            }
        } catch (err) {
            modalBody.innerHTML = `<div style="color: var(--danger); padding: 2rem;">Error: ${err.message}</div>`;
        }
    }

    // Add closeDetailModal logic update to clear interval
    function closeDetailModal() {
        document.getElementById('subdomain-detail-modal').classList.remove('active');
        document.body.classList.remove('modal-open');
        if (subdomainLogInterval) clearInterval(subdomainLogInterval);
        currentDetailDomain = null;
    }

    // Fuzzing State
    let fuzzingPollInterval = null;

    async function toggleFuzzing(domain) {
        const btn = document.getElementById('fuzz-btn');
        const isRunning = btn.getAttribute('data-running') === 'true';

        if (isRunning) {
            // Stop
            if (!confirm(`Stop fuzzing for ${domain}?`)) return;
            try {
                const scanId = currentScanId === 'all' ? 'manual' : currentScanId;
                await fetch(`/fuzzing/stop/${scanId}/${domain}`, { method: 'POST' });
                btn.innerText = 'Start Fuzzing';
                btn.className = 'btn btn-outline';
                btn.setAttribute('data-running', 'false');
                if (fuzzingPollInterval) clearInterval(fuzzingPollInterval);
            } catch (e) { alert('Failed to stop'); }
        } else {
            // Start
            const wordlist = prompt("Enter wordlist path (leave empty for default):");
            if (wordlist === null) return;

            try {
                btn.innerText = 'Starting...';
                const scanId = currentScanId === 'all' ? 'manual' : currentScanId;
                const res = await fetch(`/fuzzing/start/${scanId}/${domain}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wordlist: wordlist || null })
                });
                const data = await res.json();

                if (data.success) {
                    btn.innerText = 'üõë Stop Fuzzing';
                    btn.className = 'btn btn-danger';
                    btn.setAttribute('data-running', 'true');
                    loadFuzzingResults(domain);
                    fuzzingPollInterval = setInterval(() => loadFuzzingResults(domain), 2000);
                } else {
                    alert('Error: ' + data.error);
                    btn.innerText = 'Start Fuzzing';
                }
            } catch (e) {
                alert('Request failed');
                btn.innerText = 'Start Fuzzing';
            }
        }
    }

    async function loadFuzzingResults(domain) {
        const container = document.getElementById('fuzz-results-container');
        try {
            const scanId = currentScanId === 'all' ? 'manual' : currentScanId;
            const res = await fetch(`/fuzzing/results/${scanId}/${domain}`);
            const data = await res.json();

            if (data.results && data.results.length > 0) {
                container.style.justifyContent = 'flex-start';
                container.innerHTML = data.results.map(r => {
                    const statusClass = r.status_code === 200 ? 'fuzz-status-200' : (r.status_code >= 300 && r.status_code < 400 ? 'fuzz-status-301' : 'fuzz-status-403');
                    const badgeClass = r.status_code === 200 ? 'fuzz-badge-200' : (r.status_code >= 300 && r.status_code < 400 ? 'fuzz-badge-30x' : 'fuzz-badge-403');
                    return `
                        <div class="fuzz-result-item ${statusClass}">
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <span class="fuzz-badge ${badgeClass}">${r.status_code}</span>
                                <a href="${r.url}" target="_blank" style="color: var(--text-main); text-decoration: none; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">/${r.path}</a>
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.75rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;">
                                <span>Size: ${r.length}</span>
                                ${r.redirect_location ? `<span style="color: var(--primary);">‚Üí ${r.redirect_location}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.style.justifyContent = 'center';
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 3rem;">No sensitive paths found yet. Results appear here during active fuzzing.</p>';
            }
        } catch (e) {
            console.error("Fuzz results error", e);
        }
    }


    // Start Fuzzing
    async function startFuzzing(domain) {
        if (!confirm(`Start directory fuzzing for ${domain}?`)) return;

        try {
            // Use 'auto' as scan_id for now or currentScanId if valid
            const scanId = currentScanId === 'all' ? 'manual' : currentScanId;
            const res = await fetch(`/fuzzing/start/${scanId}/${domain}`, { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                alert(`‚úÖ Fuzzing started for ${domain}`);
                closeDetailModal();
            } else {
                alert('‚ùå Failed: ' + data.error);
            }
        } catch (e) {
            alert('‚ùå Request Failed');
        }
    }

    // Render subdomain details in modal
    function renderSubdomainDetails(details) {
        const modalBody = document.getElementById('modal-detail-body');
        const modalTitle = document.getElementById('modal-title');
        const modalSubtitle = document.getElementById('modal-subtitle');

        if (modalTitle) modalTitle.innerText = details.domain || 'Subdomain Details';
        if (modalSubtitle) modalSubtitle.innerText = 'Subdomain Intelligence & Vulnerability Surface';

        modalBody.innerHTML = `
            <div class="detail-tabs">
                <button class="detail-tab active" onclick="switchTab(event, 'overview')">Overview</button>
                <button class="detail-tab" onclick="switchTab(event, 'headers')">Headers</button>
                <button class="detail-tab" onclick="switchTab(event, 'technologies')">Technologies</button>
                <button class="detail-tab" onclick="switchTab(event, 'endpoints')">Endpoints</button>
                <button class="detail-tab" onclick="switchTab(event, 'apis')">APIs</button>
                <button class="detail-tab" onclick="switchTab(event, 'security')">Security</button>
                <button class="detail-tab" onclick="switchTab(event, 'fuzzing')">Fuzzing</button>
                <button class="detail-tab" onclick="switchTab(event, 'logs')">Logs</button>
            </div>

            <div id="tab-overview" class="tab-content">
                <div class="grid-2" style="gap: 1.5rem;">
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Infrastructure</h4>
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">
                            <div style="margin-bottom: 0.4rem;"><strong>Domain:</strong> ${details.domain}</div>
                            <div style="margin-bottom: 0.4rem;"><strong>IP:</strong> ${details.ip || details.primary_ip || 'N/A'}</div>
                            <div style="margin-bottom: 0.4rem;"><strong>ASN:</strong> ${details.asn || 'N/A'}</div>
                            <div style="margin-bottom: 0.4rem;"><strong>Org:</strong> ${details.org || 'N/A'}</div>
                            <div style="margin-bottom: 0.4rem;"><strong>Country:</strong> ${details.country || 'N/A'} ${details.city && details.city !== 'Unknown' ? `(${details.city})` : ''}</div>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Application Info</h4>
                        <div style="font-size: 0.9rem;">
                            <div style="margin-bottom: 0.4rem;">
                                <strong>Status:</strong> 
                                <span class="badge ${details.status_code ? (details.status_code < 400 ? 'badge-success' : 'badge-warning') : 'badge-danger'}">
                                    ${details.status_code ? `‚úÖ Live (${details.status_code})` : '‚ùå No Response'}
                                </span>
                            </div>
                            <div style="margin-bottom: 0.4rem;"><strong>WAF:</strong> <span style="color: ${details.waf === 'None detected' ? 'var(--text-muted)' : 'var(--warning)'}; font-weight: 600;">${details.waf || 'None detected'}</span></div>
                            <div style="margin-bottom: 0.4rem;"><strong>CDN:</strong> <span style="color: ${details.cdn === 'None detected' ? 'var(--text-muted)' : 'var(--primary)'}; font-weight: 600;">${details.cdn || 'None detected'}</span></div>
                        </div>
                    </div>
                </div>

                ${details.title ? `
                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.05);">
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Page Analysis</h4>
                        <p style="font-size: 1.1rem; font-weight: 500;">${details.title}</p>
                    </div>
                ` : ''}

                <div style="margin-top: 1.5rem; text-align: center; display: flex; gap: 0.5rem; justify-content: center;">
                    <button onclick="window.open('https://${details.domain}', '_blank')" class="btn btn-primary">
                        Visit Website ‚Üí
                    </button>
                    ${(!details.status_code || details.status_code === 'No Response') ? `
                        <button id="trigger-scan-btn" onclick="triggerIntelligenceScan('${details.domain}')" class="btn btn-outline" style="border-color: #60a5fa; color: #60a5fa;">
                            üöÄ Trigger Intelligence Scan
                        </button>
                    ` : ''}
                </div>
            </div>

            <div id="tab-logs" class="tab-content hidden">
                <div class="flex-between mb-md">
                    <h3 style="margin:0;">Live Progress Logs</h3>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Showing activity for: <strong>${details.domain}</strong></div>
                </div>
                <div id="subdomain-log-container" style="background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; height: 350px; overflow-y: auto; color: #a1a1aa; line-height: 1.5;">
                    <p style="text-align: center; padding-top: 100px;">Initializing log stream...</p>
                </div>
            </div>

            <div id="tab-headers" class="tab-content hidden">
                ${details.security_headers && Object.keys(details.security_headers).some(k => details.security_headers[k]) ? `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: var(--warning); text-transform: uppercase; letter-spacing: 0.05em;">Security Headers</h4>
                        <div class="grid-2" style="gap: 0.75rem;">
                            ${Object.entries(details.security_headers).filter(([k, v]) => v).map(([k, v]) => `
                                <div style="background: rgba(255,193,7,0.05); border: 1px solid rgba(255,193,7,0.1); padding: 0.75rem; border-radius: 6px; font-size: 0.8rem;">
                                    <div style="color: var(--warning); font-weight: 600; margin-bottom: 0.2rem;">${k.replace(/_/g, '-').toUpperCase()}</div>
                                    <div style="font-family: 'JetBrains Mono', monospace; word-break: break-all; color: var(--text-main);">${v}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <h4 style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">HTTP Raw Headers</h4>
                ${details.http_headers ? `
                    <div class="code-block" style="background: rgba(0,0,0,0.3); padding: 1.5rem; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                        ${Object.entries(details.http_headers).map(([k, v]) => `<div style="margin-bottom: 0.35rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.35rem;"><span style="color: var(--primary); font-weight: 600;">${k}:</span> <span style="color: #e5e7eb; word-break: break-all;">${v}</span></div>`).join('')}
                    </div>
                ` : '<p style="color: var(--text-muted); text-align: center; padding: 3rem; background: rgba(0,0,0,0.2); border-radius: 8px;">No HTTP headers available.</p>'}
            </div>

            <div id="tab-technologies" class="tab-content hidden">
                ${details.technologies && details.technologies.length > 0 ? (() => {
                const categorized = {};
                details.technologies.forEach(tech => {
                    const cat = (details.categorized_techs && details.categorized_techs[tech]) || 'Other';
                    if (!categorized[cat]) categorized[cat] = [];
                    categorized[cat].push(tech);
                });

                return Object.entries(categorized).map(([cat, techs]) => `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">${cat}</h4>
                            <div class="tech-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.75rem;">
                                ${techs.map(tech => {
                    const confidence = (details.confidence_scores && details.confidence_scores[tech]) || 'low';
                    const confColor = confidence === 'high' ? '#34d399' : (confidence === 'medium' ? '#fbbf24' : '#9ca3af');
                    return `
                                        <div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.1); padding: 0.75rem; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between;">
                                            <div style="color: #a78bfa; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.4rem;">${tech}</div>
                                            <div style="display: flex; align-items: center; font-size: 0.7rem; color: var(--text-muted);">
                                                <span style="width: 6px; height: 6px; border-radius: 50%; background: ${confColor}; margin-right: 0.4rem;"></span>
                                                ${confidence.toUpperCase()} CONFIDENCE
                                            </div>
                                        </div>
                                    `;
                }).join('')}
                            </div>
                        </div>
                    `).join('');
            })() : '<p style="color: var(--text-muted); text-align: center; padding: 3rem; background: rgba(0,0,0,0.2); border-radius: 8px;">No technologies identified.</p>'}
            </div>

            <div id="tab-endpoints" class="tab-content hidden">
                ${details.categorized_endpoints && Object.keys(details.categorized_endpoints).some(k => details.categorized_endpoints[k] && details.categorized_endpoints[k].length > 0) ? `
                    ${Object.entries(details.categorized_endpoints).filter(([source, list]) => list && list.length > 0).map(([source, list]) => `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">${source.replace(/_/g, ' ').replace('from ', '')}</h4>
                            <div class="code-block" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; max-height: 250px; overflow-y: auto;">
                                ${list.map(e => {
                const val = typeof e === 'object' ? (e.path || JSON.stringify(e)) : e;
                return `<div style="margin-bottom: 0.3rem; color: #e5e7eb; border-bottom: 1px solid rgba(255,255,255,0.03); padding-bottom: 0.2rem; word-break: break-all;">${val}</div>`;
            }).join('')}
                            </div>
                        </div>
                    `).join('')}
                ` : '<p style="color: var(--text-muted); text-align: center; padding: 3rem; background: rgba(0,0,0,0.2); border-radius: 8px;">No endpoints discovered yet.</p>'}
            </div>

            <div id="tab-apis" class="tab-content hidden">
                ${details.api_endpoints && details.api_endpoints.length > 0 ? `
                    <div style="background: rgba(0,0,0,0.2); border-left: 4px solid var(--primary); padding: 1.5rem; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                        <h4 style="margin: 0 0 1rem 0; font-size: 0.85rem; color: var(--primary); text-transform: uppercase; letter-spacing: 0.05em;">Detected API Endpoints</h4>
                        <div class="code-block" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; line-height: 1.8;">
                            ${details.api_endpoints.map(e => `<div style="margin-bottom: 0.4rem; color: #60a5fa; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 0.4rem; word-break: break-all;">${e}</div>`).join('')}
                        </div>
                    </div>
                ` : '<p style="color: var(--text-muted); text-align: center; padding: 3rem; background: rgba(0,0,0,0.2); border-radius: 8px;">No API endpoints identified yet.</p>'}
            </div>

            <div id="tab-security" class="tab-content hidden">
                <div class="grid-2" style="gap: 1.5rem;">
                    <div>
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Security Certificate</h4>
                        <div style="background: rgba(0,0,0,0.2); padding: 1.25rem; border-radius: 8px; border: 1px solid ${details.ssl_info?.valid ? 'rgba(52, 211, 153, 0.1)' : 'rgba(239, 68, 68, 0.1)'};">
                            <div style="margin-bottom: 0.6rem; display: flex; align-items: center;">
                                <strong style="width: 80px; font-size: 0.8rem; color: var(--text-muted);">Status:</strong> 
                                <span style="color: ${details.ssl_info?.valid ? '#34d399' : '#ef4444'}; font-weight: 600; font-size: 0.9rem;">
                                    ${details.ssl_info?.valid ? '‚úÖ Secure' : '‚ùå Insecure'}
                                </span>
                            </div>
                            <div style="margin-bottom: 0.6rem; display: flex; align-items: flex-start;">
                                <strong style="width: 80px; font-size: 0.8rem; color: var(--text-muted);">Issuer:</strong> 
                                <span style="font-size: 0.85rem; color: var(--text-main);">${details.ssl_info?.issuer || 'Unknown'}</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <strong style="width: 80px; font-size: 0.8rem; color: var(--text-muted);">Expires:</strong> 
                                <span style="font-size: 0.85rem; color: var(--text-main);">${details.ssl_info?.valid_until || 'Unknown'}</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Infrastructure</h4>
                        <div style="background: rgba(0,0,0,0.2); padding: 1.25rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 1rem;">
                            <div style="margin-bottom: 0.6rem; display: flex; align-items: center;">
                                <strong style="width: 60px; font-size: 0.8rem; color: var(--text-muted);">WAF:</strong> 
                                <span style="font-size: 0.9rem; font-weight: 500; color: ${details.waf === 'None detected' ? 'var(--text-muted)' : 'var(--warning)'};">
                                    ${details.waf || 'None detected'}
                                </span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <strong style="width: 60px; font-size: 0.8rem; color: var(--text-muted);">CDN:</strong> 
                                <span style="font-size: 0.9rem; font-weight: 500; color: ${details.cdn === 'None detected' ? 'var(--text-muted)' : 'var(--primary)'};">
                                    ${details.cdn || 'None detected'}
                                </span>
                            </div>
                        </div>
                        
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">DNS Records</h4>
                        <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 8px; max-height: 120px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.05);">
                            ${details.dns_records ? Object.entries(details.dns_records).filter(([k, v]) => v && v.length > 0).map(([k, v]) => `<div><strong style="color: #60a5fa;">${k}:</strong> ${v.join(', ')}</div>`).join('\n') : 'No DNS records found'}
                        </div>
                    </div>
                </div>

                ${details.security_headers ? (() => {
                const missing = [];
                const headers = {
                    'X-Frame-Options': 'x_frame_options',
                    'X-Content-Type-Options': 'x_content_type_options',
                    'Content-Security-Policy': 'content_security_policy',
                    'Strict-Transport-Security': 'strict_transport_security'
                };
                Object.entries(headers).forEach(([name, key]) => {
                    if (!details.security_headers[key]) missing.push(name);
                });

                if (missing.length === 0) return '';

                return `
                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin: 0 0 0.75rem 0; font-size: 0.85rem; color: var(--danger); text-transform: uppercase; letter-spacing: 0.05em;">Missing Security Headers</h4>
                            <div class="code-block" style="background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px;">
                                ${missing.map(h => `<div style="color: #fca5a5; font-size: 0.85rem; font-family: 'JetBrains Mono', monospace; margin-bottom: 0.4rem;">[-] Missing: ${h}</div>`).join('')}
                            </div>
                        </div>
                    `;
            })() : ''}
            </div>

            <div id="tab-fuzzing" class="tab-content hidden">
                <div class="flex-between mb-md">
                    <h3 style="margin:0;">Directory Fuzzing</h3>
                    <button id="fuzz-btn" class="btn btn-outline" onclick="toggleFuzzing('${details.domain}')" data-running="false" style="border-color: #60a5fa; color: #60a5fa;">
                        üöÄ Start Directory Build-out
                    </button>
                </div>
                <div style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 12px;">
                    <h4 style="margin-top: 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase;">Discovered Sensitive Paths</h4>
                    <div id="fuzz-results-container" class="fuzz-result-list" style="margin-top: 1rem; min-height: 200px; display: flex; flex-direction: column; justify-content: center;">
                        <p style="text-align: center; color: var(--text-muted);">Launch directory brute-forcing to discover hidden files and folders.</p>
                    </div>
                </div>
            </div>
        `;

    }

    // Switch tabs in modal
    let subdomainLogInterval = null;
    let currentDetailDomain = null;

    function switchTab(e, tabName) {
        if (e) e.preventDefault();
        const target = e ? e.currentTarget : document.querySelector(`.detail-tab[onclick*="${tabName}"]`);

        console.log(`Switching to tab: ${tabName}`);

        // Remove active from all tabs
        document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
            content.style.display = 'none';
        });

        // Activate clicked tab
        if (target) target.classList.add('active');

        const contentPanel = document.getElementById(`tab-${tabName}`);
        if (contentPanel) {
            contentPanel.classList.remove('hidden');
            contentPanel.style.display = 'block';
            console.log(`Showing panel: tab-${tabName}`);
        } else {
            console.error(`Panel not found: tab-${tabName}`);
        }

        // Handle Logs Tab Polling
        if (subdomainLogInterval) clearInterval(subdomainLogInterval);
        if (tabName === 'logs' && currentDetailDomain) {
            pollSubdomainLogs(currentDetailDomain);
            subdomainLogInterval = setInterval(() => pollSubdomainLogs(currentDetailDomain), 2000);
        }
    }

    async function pollSubdomainLogs(domain) {
        const container = document.getElementById('subdomain-log-container');
        if (!container) return;

        try {
            const res = await fetch('/get_logs');
            const data = await res.json();
            const logs = data.logs || [];

            // Filter logs mentioning the domain
            const filtered = logs.filter(line => line.toLowerCase().includes(domain.toLowerCase()));

            if (filtered.length > 0) {
                container.innerHTML = filtered.map(line => `<div style="margin-bottom: 2px;">${escapeHtml(line)}</div>`).join('');
                container.scrollTop = container.scrollHeight;
            } else {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding-top: 100px;">No specific logs found for this subdomain yet...</p>';
            }
        } catch (e) {
            console.error("Log fetch error:", e);
        }
    }

    async function triggerIntelligenceScan(domain) {
        const btn = document.getElementById('trigger-scan-btn');
        if (!confirm(`Start deep intelligence gathering for ${domain}?`)) return;

        try {
            btn.disabled = true;
            btn.innerText = '‚åõ Starting...';

            const res = await fetch('/subdomains/trigger_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain: domain })
            });
            const data = await res.json();

            if (data.success) {
                btn.innerText = 'üöÄ Scan Progressive';
                // Switch to logs tab to show progress
                const logsTab = Array.from(document.querySelectorAll('.detail-tab')).find(t => t.innerText.includes('Logs'));
                if (logsTab) logsTab.click();
            } else {
                alert('Error: ' + data.error);
                btn.disabled = false;
                btn.innerText = 'üöÄ Trigger Intelligence Scan';
            }
        } catch (e) {
            alert('Request failed');
            btn.disabled = false;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close detail modal
    function closeDetailModal() {
        document.getElementById('subdomain-detail-modal').classList.remove('active');
    }

    // Update stats
    function updateStats(total) {
        document.getElementById('stat-total').innerText = total;
        // Note: For other stats, we would need a separate aggregation API endpoint since we don't have all data client-side anymore. 
        // For now we leave them as N/A or implement a separate stats call in future. 
        // For Active Websites, we can approximate or disable for now to save fetch.

        // Simple client side count of current page is not enough. 
        // We will leave others as 0 or N/A for this iteration to prioritize performance.
    }

    // Update filter count
    function updateFilterCount() {
        let count = 0;
        if (document.getElementById('filter-status').value) count++;
        if (document.getElementById('filter-source').value) count++;
        if (document.getElementById('filter-has-site').value) count++;

        const badge = document.getElementById('filter-count');
        badge.innerText = count;
        badge.style.display = count > 0 ? 'inline-block' : 'none';
    }

    // Toggle filters
    function toggleFilters() {
        const panel = document.getElementById('filter-panel');
        panel.classList.toggle('hidden');
    }

    // Clear filters
    function clearFilters() {
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-source').value = '';
        document.getElementById('filter-has-site').value = '';
        document.getElementById('sort-by').value = 'newest';
        applyFilters();
    }

    // Clear search
    function clearSearch() {
        document.getElementById('subdomain-search').value = '';
        applyFilters();
    }

    // Auto refresh
    function toggleAutoRefresh() {
        const btn = document.getElementById('auto-refresh-btn');

        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            btn.innerText = '‚è∏Ô∏è Auto Refresh';
        } else {
            autoRefreshInterval = setInterval(() => loadSubdomains(currentPage), 5000); // Reload current page
            btn.innerText = '‚ñ∂Ô∏è Auto Refresh (Active)';
        }
    }

    // Refresh subdomains
    function refreshSubdomains() {
        loadSubdomains(currentPage);
    }

    // Export subdomains - requires server side export logic or fetching all data (careful!)
    // For now, we will implement client side export of CURRENT PAGE or alert user limitation
    async function exportSubdomains() {
        alert("Export will download the current view's results.");
        // Re-implement properly in a separate task or just dump current filtered view logic
        // For server-side export, we need a new route. 
    }

    // Pagination Controls
    function updatePaginationControls() {
        const pagination = document.getElementById('pagination');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const pageInfo = document.getElementById('page-info');
        const showingCount = document.getElementById('showing-count');

        if (totalItems === 0) {
            pagination.classList.add('hidden');
            showingCount.innerText = "Showing 0 results";
            return;
        }

        pagination.classList.remove('hidden');
        pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        const start = (currentPage - 1) * perPage + 1;
        const end = Math.min(start + perPage - 1, totalItems);
        showingCount.innerText = `Showing ${start}-${end} of ${totalItems} results`;
    }

    function prevPage() {
        if (currentPage > 1) {
            loadSubdomains(currentPage - 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            loadSubdomains(currentPage + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // Error handling
    function showError(message) {
        const container = document.getElementById('subdomains-container');
        container.innerHTML = `
            <div style="color: var(--danger); padding: 2rem; text-align: center;">
                <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</p>
                <p>${message}</p>
            </div>
        `;
    }

    // Close modal on outside click
    window.onclick = function (event) {
        const modal = document.getElementById('subdomain-detail-modal');
        if (event.target === modal) {
            closeDetailModal();
        }
    };
</script>
{% endblock %}