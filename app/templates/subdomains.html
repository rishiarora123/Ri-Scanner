{% extends "base.html" %}

{% block title %}Subdomains - Ri-Scanner Pro{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="text-center mb-lg">
        <h1 class="gradient-text">üåê Discovered Websites & Subdomains</h1>
        <p class="text-muted" style="font-size: 1.1rem;">
            All websites and subdomains found across all your scans
        </p>
    </div>

    <!-- Controls Bar -->
    <div class="glass card mb-md">
        <div class="flex-between" style="gap: 1rem; flex-wrap: wrap;">
            <!-- Search -->
            <div style="flex: 1; min-width: 300px;">
                <div class="search-container">
                    <input type="text" id="subdomain-search" class="form-input"
                        placeholder="üîç Search websites (e.g., google.com, api, login...)"
                        style="padding-right: 2.5rem;">
                    <button onclick="clearSearch()" class="clear-search"
                        style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem;">√ó</button>
                </div>
            </div>

            <!-- Filters & Actions -->
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button onclick="toggleFilters()" class="btn btn-outline" id="filter-toggle-btn">
                    üéöÔ∏è Filters <span id="filter-count" class="badge badge-info" style="margin-left: 0.25rem;">0</span>
                </button>
                <button onclick="toggleAutoRefresh()" class="btn btn-outline" id="auto-refresh-btn">
                    ‚è∏Ô∏è Auto Refresh
                </button>
                <button onclick="exportSubdomains()" class="btn btn-outline">
                    üì• Export
                </button>
                <button onclick="refreshSubdomains()" class="btn btn-primary">
                    üîÑ Refresh Now
                </button>
            </div>
        </div>

        <!-- Filter Panel (Collapsible) -->
        <div id="filter-panel" class="hidden"
            style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--glass-border);">
            <div class="grid-4" style="gap: 1rem;">
                <!-- Status Code Filter -->
                <div>
                    <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Response Status</label>
                    <select id="filter-status" class="form-input" onchange="applyFilters()">
                        <option value="">All Statuses</option>
                        <option value="200">‚úÖ 200 - OK</option>
                        <option value="301">‚Ü™Ô∏è 301 - Redirect</option>
                        <option value="302">‚Ü™Ô∏è 302 - Redirect</option>
                        <option value="403">üö´ 403 - Forbidden</option>
                        <option value="404">‚ùå 404 - Not Found</option>
                        <option value="500">‚ö†Ô∏è 500 - Server Error</option>
                    </select>
                </div>

                <!-- Source Filter -->
                <div>
                    <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Discovery Method</label>
                    <select id="filter-source" class="form-input" onchange="applyFilters()">
                        <option value="">All Sources</option>
                        <option value="recon">üîç Full Scan</option>
                        <option value="asn">üè¢ Network Scan</option>
                        <option value="extraction">üìä Port Scanner</option>
                        <option value="manual">‚úèÔ∏è Manual</option>
                    </select>
                </div>

                <!-- Has Website Filter -->
                <div>
                    <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Website Status</label>
                    <select id="filter-has-site" class="form-input" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="yes">Has Website</option>
                        <option value="no">No Website</option>
                    </select>
                </div>

                <!-- Sort By -->
                <div>
                    <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Sort By</label>
                    <select id="sort-by" class="form-input" onchange="applyFilters()">
                        <option value="newest">üïê Newest First</option>
                        <option value="oldest">üïí Oldest First</option>
                        <option value="domain">üî§ Domain A-Z</option>
                        <option value="status">üìä Status Code</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 1rem; text-align: right;">
                <button onclick="clearFilters()" class="btn btn-outline" style="font-size: 0.85rem;">
                    Clear All Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="stat-grid mb-md">
        <div class="stat-card">
            <div id="stat-total" class="stat-value">0</div>
            <div class="stat-label">Total Subdomains</div>
        </div>
        <div class="stat-card">
            <div id="stat-active" class="stat-value">0</div>
            <div class="stat-label">Active Websites</div>
        </div>
        <div class="stat-card">
            <div id="stat-unique-ips" class="stat-value">N/A</div>
            <div class="stat-label">Unique Servers</div>
        </div>
        <div class="stat-card">
            <div id="stat-tech-detected" class="stat-value">N/A</div>
            <div class="stat-label">Technologies Found</div>
        </div>
    </div>

    <!-- Subdomains List -->
    <div class="glass card">
        <div class="flex-between mb-md">
            <h2 style="margin: 0;">üìã Subdomain List</h2>
            <div id="showing-count" style="font-size: 0.9rem; color: var(--text-muted);">
                Showing 0 results
            </div>
        </div>

        <div id="subdomains-container">
            <div class="text-center" style="padding: 3rem; color: var(--text-muted);">
                <div class="spinner" style="margin: 0 auto 1rem;"></div>
                <p>Loading websites...</p>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="hidden" style="margin-top: 1.5rem; text-align: center;">
            <button onclick="prevPage()" id="prev-btn" class="btn btn-outline">‚Üê Previous</button>
            <span id="page-info" style="margin: 0 1rem; color: var(--text-muted);">Page 1 of 1</span>
            <button onclick="nextPage()" id="next-btn" class="btn btn-outline">Next ‚Üí</button>
        </div>
    </div>
</div>

<!-- Subdomain Detail Modal -->
<div id="subdomain-detail-modal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 id="modal-title" style="margin: 0;">Subdomain Details</h2>
            <button class="close-btn" onclick="closeDetailModal()">√ó</button>
        </div>
        <div class="modal-body" id="modal-detail-body">
            <div class="text-center" style="padding: 3rem;">
                <div class="spinner"></div>
                <p>Loading details...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .subdomain-card {
        padding: 1.25rem;
        margin-bottom: 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: var(--radius-md);
        border-left: 4px solid var(--primary);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .subdomain-card:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .subdomain-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }

    .subdomain-domain {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary);
        word-break: break-all;
        font-family: 'JetBrains Mono', monospace;
    }

    .subdomain-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .tech-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: rgba(59, 130, 246, 0.2);
        border-radius: 4px;
        font-size: 0.7rem;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }

    .status-badge-200 {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success);
    }

    .status-badge-301,
    .status-badge-302 {
        background: rgba(59, 130, 246, 0.2);
        color: var(--secondary);
    }

    .status-badge-403,
    .status-badge-404 {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger);
    }

    .status-badge-500 {
        background: rgba(245, 158, 11, 0.2);
        color: var(--warning);
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        max-height: 90vh;
        overflow-y: auto;
        width: 90%;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--glass-border);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 2rem;
        color: var(--text-muted);
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
    }

    .close-btn:hover {
        color: var(--text-primary);
    }

    .search-container {
        position: relative;
    }

    .detail-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid var(--glass-border);
    }

    .detail-tab {
        padding: 0.75rem 1rem;
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all var(--transition-fast);
    }

    .detail-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .detail-tab:hover {
        color: var(--text-primary);
    }
</style>

<script>
    // State
    let currentPage = 1;
    let totalPages = 1;
    let totalItems = 0;
    const perPage = 20;
    let autoRefreshInterval = null;
    let currentScanId = 'all';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadSubdomains(1);
        setupSearchListener();
    });

    // Setup search listener with debounce
    function setupSearchListener() {
        const searchInput = document.getElementById('subdomain-search');
        let timeout = null;

        searchInput.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                applyFilters();
            }, 500); // 500ms debounce
        });
    }

    // Load subdomains from server (paginated)
    async function loadSubdomains(page = 1) {
        currentPage = page;

        // Collect filters
        const search = document.getElementById('subdomain-search').value;
        const status = document.getElementById('filter-status').value;
        const source = document.getElementById('filter-source').value;
        const hasSite = document.getElementById('filter-has-site').value;
        const sortBy = document.getElementById('sort-by').value;

        // Show loading
        const container = document.getElementById('subdomains-container');
        if (page === 1) { // Only clear container on full reload/search, not necessarily page change but cleaner
            container.innerHTML = `
                <div class="text-center" style="padding: 3rem; color: var(--text-muted);">
                    <div class="spinner" style="margin: 0 auto 1rem;"></div>
                    <p>Loading websites...</p>
                </div>
            `;
        }

        try {
            // Build URL
            const params = new URLSearchParams({
                page: page,
                per_page: perPage,
                search: search,
                status: status,
                source: source,
                has_site: hasSite,
                sort_by: sortBy
            });

            const res = await fetch(`/subdomains/list/${currentScanId}?${params.toString()}`);
            const data = await res.json();

            if (data.success) {
                renderSubdomains(data.subdomains);

                // Update pagination state
                totalItems = data.total;
                totalPages = data.pages;
                currentPage = data.page;

                updatePaginationControls();
                updateStats(totalItems); // Simply update total count for now
                updateFilterCount();
            } else {
                showError('Failed to load subdomains');
            }
        } catch (err) {
            showError('Error: ' + err.message);
        }
    }

    // Apply filters -> simply reload page 1 with new params
    function applyFilters() {
        loadSubdomains(1);
    }

    // Render subdomains list
    function renderSubdomains(subdomains) {
        const container = document.getElementById('subdomains-container');

        if (!subdomains || subdomains.length === 0) {
            container.innerHTML = `
                <div class="text-center" style="padding: 3rem; color: var(--text-muted);">
                    <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">üîç</p>
                    <p>No websites found matching your filters</p>
                    <p style="font-size: 0.85rem;">Try clearing filters or starting a new scan</p>
                </div>
            `;
            return;
        }

        container.innerHTML = subdomains.map(sub => createSubdomainCard(sub)).join('');
    }

    // Create subdomain card HTML
    function createSubdomainCard(sub) {
        const statusClass = `status-badge-${sub.status_code || '000'}`;
        const statusText = sub.status_code || 'No Response';

        return `
            <div class="subdomain-card" onclick="viewSubdomainDetails('${sub.domain}')">
                <div class="subdomain-header">
                    <div>
                        <div class="subdomain-domain">${sub.domain}</div>
                        <div class="subdomain-meta">
                            <div class="meta-item">
                                <span class="badge ${statusClass}">${statusText}</span>
                            </div>
                            ${sub.ip ? `<div class="meta-item">üñ•Ô∏è ${sub.ip}</div>` : ''}
                            ${sub.source ? `<div class="meta-item">üì° ${getSourceLabel(sub.source)}</div>` : ''}
                        </div>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); window.open('https://${sub.domain}', '_blank')" style="padding: 0.5rem 1rem;">
                        üîó Visit
                    </button>
                </div>
                ${sub.technologies && sub.technologies.length > 0 ? `
                    <div style="margin-top: 0.75rem;">
                        ${sub.technologies.slice(0, 5).map(tech => `<span class="tech-badge">${tech}</span>`).join('')}
                        ${sub.technologies.length > 5 ? `<span class="tech-badge">+${sub.technologies.length - 5} more</span>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Get source label
    function getSourceLabel(source) {
        const labels = {
            'recon': 'Full Scan',
            'asn': 'Network Scan',
            'extraction': 'Port Scanner',
            'manual': 'Manual'
        };
        return labels[source] || source;
    }

    // View subdomain details
    async function viewSubdomainDetails(domain) {
        const modal = document.getElementById('subdomain-detail-modal');
        const modalBody = document.getElementById('modal-detail-body');
        const modalTitle = document.getElementById('modal-title');

        modalTitle.innerText = domain;
        modal.classList.add('active');

        modalBody.innerHTML = '<div class="text-center" style="padding: 3rem;"><div class="spinner"></div><p>Loading details...</p></div>';

        try {
            const res = await fetch(`/subdomains/details/${currentScanId}/${encodeURIComponent(domain)}`);
            const data = await res.json();

            if (data.success && data.details) {
                renderSubdomainDetails(data.details);
            } else {
                modalBody.innerHTML = '<div style="color: var(--danger); padding: 2rem;">Failed to load details</div>';
            }
        } catch (err) {
            modalBody.innerHTML = `<div style="color: var(--danger); padding: 2rem;">Error: ${err.message}</div>`;
        }
    }

    // Render subdomain details in modal
    function renderSubdomainDetails(details) {
        const modalBody = document.getElementById('modal-detail-body');

        modalBody.innerHTML = `
            <div class="detail-tabs">
                <button class="detail-tab active" onclick="switchTab(event, 'overview')">Overview</button>
                <button class="detail-tab" onclick="switchTab(event, 'technologies')">Technologies</button>
                <button class="detail-tab" onclick="switchTab(event, 'security')">Security</button>
            </div>

            <div id="tab-overview" class="tab-content">
                <div class="grid-2" style="gap: 1rem;">
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-muted);">Domain</h4>
                        <p style="font-family: 'JetBrains Mono', monospace;">${details.domain || 'N/A'}</p>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-muted);">IP Address</h4>
                        <p>${details.ip || 'N/A'}</p>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-muted);">Status Code</h4>
                        <p>${details.status_code || 'No Response'}</p>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-muted);">Response Time</h4>
                        <p>${details.response_time_ms ? details.response_time_ms + ' ms' : 'N/A'}</p>
                    </div>
                </div>

                ${details.title ? `
                    <div style="margin-top: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-muted);">Page Title</h4>
                       <p>${details.title}</p>
                    </div>
                ` : ''}

                <div style="margin-top: 1.5rem; text-align: center;">
                    <button onclick="window.open('https://${details.domain}', '_blank')" class="btn btn-primary">
                        Visit Website ‚Üí
                    </button>
                </div>
            </div>

            <div id="tab-technologies" class="tab-content hidden">
                ${details.technologies && details.technologies.length > 0 ? `
                    <div>
                        ${details.technologies.map(tech => `<span class="tech-badge">${tech}</span>`).join('')}
                    </div>
                ` : '<p style="color: var(--text-muted);">No technologies detected</p>'}
            </div>

            <div id="tab-security" class="tab-content hidden">
                <div class="grid-2" style="gap: 1rem;">
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-muted);">WAF Detected</h4>
                        <p>${details.waf || 'None detected'}</p>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-muted);">SSL/TLS</h4>
                        <p>${details.jarm_hash ? 'Enabled' : 'Unknown'}</p>
                    </div>
                </div>
            </div>
        `;
    }

    // Switch tabs in modal
    function switchTab(e, tabName) {
        // Remove active from all tabs
        document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

        // Activate clicked tab
        e.target.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
    }

    // Close detail modal
    function closeDetailModal() {
        document.getElementById('subdomain-detail-modal').classList.remove('active');
    }

    // Update stats
    function updateStats(total) {
        document.getElementById('stat-total').innerText = total;
        // Note: For other stats, we would need a separate aggregation API endpoint since we don't have all data client-side anymore. 
        // For now we leave them as N/A or implement a separate stats call in future. 
        // For Active Websites, we can approximate or disable for now to save fetch.

        // Simple client side count of current page is not enough. 
        // We will leave others as 0 or N/A for this iteration to prioritize performance.
    }

    // Update filter count
    function updateFilterCount() {
        let count = 0;
        if (document.getElementById('filter-status').value) count++;
        if (document.getElementById('filter-source').value) count++;
        if (document.getElementById('filter-has-site').value) count++;

        const badge = document.getElementById('filter-count');
        badge.innerText = count;
        badge.style.display = count > 0 ? 'inline-block' : 'none';
    }

    // Toggle filters
    function toggleFilters() {
        const panel = document.getElementById('filter-panel');
        panel.classList.toggle('hidden');
    }

    // Clear filters
    function clearFilters() {
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-source').value = '';
        document.getElementById('filter-has-site').value = '';
        document.getElementById('sort-by').value = 'newest';
        applyFilters();
    }

    // Clear search
    function clearSearch() {
        document.getElementById('subdomain-search').value = '';
        applyFilters();
    }

    // Auto refresh
    function toggleAutoRefresh() {
        const btn = document.getElementById('auto-refresh-btn');

        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            btn.innerText = '‚è∏Ô∏è Auto Refresh';
        } else {
            autoRefreshInterval = setInterval(() => loadSubdomains(currentPage), 5000); // Reload current page
            btn.innerText = '‚ñ∂Ô∏è Auto Refresh (Active)';
        }
    }

    // Refresh subdomains
    function refreshSubdomains() {
        loadSubdomains(currentPage);
    }

    // Export subdomains - requires server side export logic or fetching all data (careful!)
    // For now, we will implement client side export of CURRENT PAGE or alert user limitation
    async function exportSubdomains() {
        alert("Export will download the current view's results.");
        // Re-implement properly in a separate task or just dump current filtered view logic
        // For server-side export, we need a new route. 
    }

    // Pagination Controls
    function updatePaginationControls() {
        const pagination = document.getElementById('pagination');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const pageInfo = document.getElementById('page-info');
        const showingCount = document.getElementById('showing-count');

        if (totalItems === 0) {
            pagination.classList.add('hidden');
            showingCount.innerText = "Showing 0 results";
            return;
        }

        pagination.classList.remove('hidden');
        pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        const start = (currentPage - 1) * perPage + 1;
        const end = Math.min(start + perPage - 1, totalItems);
        showingCount.innerText = `Showing ${start}-${end} of ${totalItems} results`;
    }

    function prevPage() {
        if (currentPage > 1) {
            loadSubdomains(currentPage - 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            loadSubdomains(currentPage + 1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    // Error handling
    function showError(message) {
        const container = document.getElementById('subdomains-container');
        container.innerHTML = `
            <div style="color: var(--danger); padding: 2rem; text-align: center;">
                <p style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</p>
                <p>${message}</p>
            </div>
        `;
    }

    // Close modal on outside click
    window.onclick = function (event) {
        const modal = document.getElementById('subdomain-detail-modal');
        if (event.target === modal) {
            closeDetailModal();
        }
    };
</script>
{% endblock %}