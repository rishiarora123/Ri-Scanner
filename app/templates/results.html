{% extends "base.html" %}

{% block title %}Results - Ri-Scanner Pro{% endblock %}

{% block content %}
<div class="glass card" style="max-width: 1200px; margin: 0 auto;" id="main-results-container">
    <!-- FIX: Info banner ‚Äî Search tab only shows completed/indexed scan data, not raw Phase 1 dumps -->
    <div
        style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.25); border-radius: 8px; padding: 0.6rem 1rem; margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-secondary, #aaa);">
        ‚ÑπÔ∏è Showing completed scan results only. Discovered subdomains are in the <a href="/subdomains"
            style="color: var(--primary); text-decoration: underline;">Websites</a> tab.
    </div>
    <div class="flex-between mb-lg">
        <h2 style="margin: 0;">Search Results</h2>
        <div class="flex gap-sm">
            <span style="color: var(--text-muted); font-size: 0.9rem; margin-right: 1rem;">Total: <strong
                    id="total-count">0</strong></span>
            <label class="flex gap-xs"
                style="color: var(--text-muted); font-size: 0.9rem; cursor: pointer; user-select: none;">
                <input type="checkbox" id="select-all-checkbox" onclick="toggleSelectAll(this)"> Select All
            </label>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="flex gap-sm mb-md">
        <input type="text" id="search-input" class="form-input" style="margin-bottom: 0; flex: 1;"
            placeholder="Search by title, IP, or domain...">
        <button class="btn btn-primary" onclick="performSearch(1)">Search</button>
        <button class="btn btn-outline" onclick="clearFilters()">Clear Filters</button>
        <div class="flex gap-xs"
            style="align-items: center; background: rgba(0,0,0,0.2); padding: 0.25rem 0.75rem; border-radius: var(--radius-sm); border: 1px solid var(--glass-border);">
            <input type="checkbox" id="auto-refresh-check" onchange="toggleAutoRefresh(this)">
            <label for="auto-refresh-check"
                style="font-size: 0.8rem; color: var(--text-secondary); cursor: pointer;">Auto-Refresh</label>
        </div>
        <button class="btn btn-outline" onclick="toggleFilters()">Advanced UI</button>
        <button id="fuzz-selected-btn" class="btn btn-success hidden" onclick="fuzzSelected()">Fuzz Selected
            (0)</button>
        <button class="btn btn-outline" onclick="exportResults()">Export</button>
    </div>

    <!-- Per Page Selector -->
    <div class="flex gap-md mb-md" style="align-items: center;">
        <span style="color: var(--text-muted); font-size: 0.9rem;">Show:</span>
        <select id="per-page-select" class="form-input" style="width: auto; margin-bottom: 0;"
            onchange="performSearch(1)">
            <option value="10">10</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
        </select>
        <span style="color: var(--text-muted); font-size: 0.9rem;">per page</span>
    </div>

    <!-- Advanced Filters -->
    <div id="filters-panel" class="glass-solid mb-md hidden" style="padding: 1rem;">
        <div class="flex-between mb-sm">
            <h4 style="margin: 0;">Advanced Filters</h4>
            <button class="btn btn-outline" onclick="addFilter()" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">+
                Add Filter</button>
        </div>
        <div id="filters-container"></div>
        <div class="flex gap-sm mt-md">
            <button class="btn btn-primary" onclick="performSearch(1)">Update Results</button>
        </div>
    </div>

    <!-- Fuzzing Progress Panel -->
    <div id="fuzz-status-container" class="glass-solid mb-md hidden"
        style="padding: 1rem; border-left: 4px solid var(--success);">
        <div class="flex-between mb-sm">
            <h4 style="margin: 0; color: var(--success);">üì° Live Discovery</h4>
            <span style="font-size: 0.8rem; color: var(--text-muted);">New paths found in real-time</span>
        </div>
        <div id="fuzz-hits-list" style="max-height: 200px; overflow-y: auto;"></div>
    </div>

    <!-- Results Container -->
    <div id="results-container" style="min-height: 400px;"></div>

    <!-- Pagination -->
    <div id="pagination" class="flex-center gap-sm mt-lg" style="flex-wrap: wrap;"></div>
</div>

<!-- Result Detail Modal - FULL SCREEN -->
<div id="modal-overlay" class="modal-overlay" onclick="closeModal()"></div>
<div id="detail-modal" class="glass modal"
    style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; max-width: 100%; max-height: 100vh; width: 100%; height: 100vh; transform: none; border-radius: 0; display: none; z-index: 9999; flex-direction: column; overflow: hidden;">
    <!-- Header -->
    <div
        style="padding: 1.5rem; border-bottom: 1px solid rgba(59, 130, 246, 0.2); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
        <div>
            <h2 class="modal-title" style="margin: 0 0 0.25rem 0; font-size: 1.8rem;">IP Reconnaissance Details</h2>
            <p style="margin: 0; color: #9ca3af; font-size: 0.9rem;" id="detail-subtitle">Loading...</p>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <div id="detail-actions" class="flex gap-sm" style="display: none;">
                <button class="btn btn-primary" onclick="startFuzz()"
                    style="padding: 0.5rem 1rem; font-size: 0.9rem;">üîç Directory Fuzz</button>
                <button class="btn btn-outline" onclick="moveToRecon()"
                    style="padding: 0.5rem 1rem; font-size: 0.9rem;">üåê Send to Website Tab</button>
            </div>
            <button onclick="closeModal()" class="btn btn-outline"
                style="padding: 0.5rem 1rem; font-size: 1.2rem; width: auto;">‚úï Close</button>
        </div>
    </div>

    <!-- Content - Scrollable -->
    <div id="detail-content"
        style="flex: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem;">
        <div style="text-align: center; color: #9ca3af;">Loading...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .filter-row {
        display: grid;
        grid-template-columns: 1fr 140px 1fr auto;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        align-items: center;
    }

    .filter-row select,
    .filter-row input {
        padding: 0.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .filter-remove {
        background: transparent;
        border: none;
        color: var(--danger);
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0.25rem;
    }

    .detail-section {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: var(--radius-sm);
    }

    .detail-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-bottom: 0.25rem;
    }

    .detail-value {
        font-family: 'JetBrains Mono', monospace;
        word-break: break-all;
    }

    .page-btn {
        min-width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .page-btn:hover:not(.active):not(:disabled) {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
    }

    .page-btn.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .page-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .domain-badge {
        font-size: 0.8rem;
        color: var(--info);
        background: rgba(6, 182, 212, 0.15);
        padding: 2px 8px;
        border-radius: 4px;
        margin-left: 0.5rem;
    }

    /* Full-Screen Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 9998;
    }

    .modal-overlay.active {
        display: block;
    }

    body.modal-open {
        overflow: hidden;
    }

    #detail-modal.active {
        display: flex !important;
    }

    #detail-modal {
        background: linear-gradient(135deg, rgba(17, 24, 39, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
        backdrop-filter: blur(10px);
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
    }

    .detail-item {
        background: rgba(59, 130, 246, 0.05);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 8px;
        padding: 1rem;
    }

    .detail-item .label {
        font-size: 0.8rem;
        color: #9ca3af;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.5rem;
        letter-spacing: 0.5px;
    }

    .detail-item .value {
        font-size: 1rem;
        color: #e5e7eb;
        word-break: break-word;
        font-family: 'Monaco', 'Courier New', monospace;
    }

    .detail-section {
        background: rgba(17, 24, 39, 0.6);
        border: 1px solid rgba(59, 130, 246, 0.1);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .detail-section h3 {
        margin: 0 0 1rem 0;
        font-size: 1.2rem;
        color: #60a5fa;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .detail-section h4 {
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
        color: #e5e7eb;
    }

    .code-block {
        background: rgba(0, 0, 0, 0.8);
        border: 1px solid rgba(59, 130, 246, 0.1);
        border-radius: 6px;
        padding: 1rem;
        font-size: 0.75rem;
        color: #a1a1aa;
        font-family: 'Monaco', 'Courier New', monospace;
        overflow-x: auto;
        max-height: 300px;
        overflow-y: auto;
        line-height: 1.5;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .tech-tag {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        font-size: 0.8rem;
        color: #60a5fa;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
</style>

<script>
    let currentPage = 1;
    let totalPages = 1;
    let filtersVisible = false;
    let filterCount = 0;
    let selectedTargets = new Set();
    let refreshInterval = null;
    let lastRefreshCount = 0;

    // HTML escape function to prevent XSS
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    function updateFuzzButton() {
        const btn = document.getElementById('fuzz-selected-btn');
        if (selectedTargets.size > 0) {
            btn.classList.remove('hidden');
            btn.innerText = `Fuzz Selected (${selectedTargets.size})`;
        } else {
            btn.classList.add('hidden');
        }
    }

    function toggleSelect(idx, checkbox) {
        const cards = document.querySelectorAll('.result-card');
        const data = JSON.parse(cards[idx].dataset.result);

        // Schema-Agnostic detail extraction
        let resp = data.http_responseForIP || data.https_responseForIP ||
            data.http_responseForDomainName || data.https_responseForDomainName;
        if (!resp) resp = data;
        const main = Array.isArray(resp) ? resp[0] || {} : resp;

        const target = Array.isArray(resp) ? (resp[0]?.request || resp[0]?.ip) : (resp.request || resp.ip);

        if (checkbox.checked) {
            selectedTargets.add(target);
        } else {
            selectedTargets.delete(target);
        }
        updateFuzzButton();
    }

    async function fuzzSelected() {
        const targets = Array.from(selectedTargets);
        if (targets.length === 0) return;

        try {
            const res = await fetch('/fuzz/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targets })
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error);

            alert(`Fuzzing job started! (ID: ${data.job_id})\nMonitoring discovery in real-time...`);
            startFuzzMonitor();
        } catch (e) {
            alert('Fuzzing failed to start: ' + e.message);
        }
    }

    function startFuzzMonitor() {
        // Poll every 2 seconds for new hits
        setInterval(async () => {
            try {
                const res = await fetch('/fuzz/status');
                const data = await res.json();
                renderFuzzProgress(data);
            } catch (e) { }
        }, 2000);
    }

    function renderFuzzProgress(data) {
        const container = document.getElementById('fuzz-status-container');
        if (!container) return;

        const hasActive = Object.values(data.jobs).some(j => j.status === 'running');
        container.classList.toggle('hidden', !hasActive && data.recent_hits.length === 0);

        if (data.recent_hits.length > 0) {
            const hitsHtml = data.recent_hits.map(hit => `
                <div class="log-entry" style="font-size: 0.8rem; border-left: 2px solid var(--success); padding-left: 0.5rem; margin-bottom: 0.25rem;">
                    <span style="color: var(--success); font-weight: bold;">[DISCOVERED]</span> 
                    <span style="color: var(--text-primary);">${hit.status}</span> 
                    <a href="${hit.url}" target="_blank" style="color: var(--primary);">${hit.url}</a>
                </div>
            `).join('');
            document.getElementById('fuzz-hits-list').innerHTML = hitsHtml;
        }
    }

    // Perform search with pagination
    // Unified search function for both quick search and advanced filters
    async function performSearch(page = 1) {
        currentPage = page;
        const q = document.getElementById('search-input').value || '';
        const perPage = document.getElementById('per-page-select').value;
        const filtersPanel = document.getElementById('filters-panel');

        // Collect advanced filters if panel is visible
        let filters = [];
        if (!filtersPanel.classList.contains('hidden')) {
            const rows = document.querySelectorAll('.filter-row');
            rows.forEach(row => {
                const field = row.querySelector('.filter-field').value;
                const operator = row.querySelector('.filter-operator').value;
                const value = row.querySelector('.filter-value').value;
                if (value.trim()) {
                    filters.push({ field, operator, value });
                }
            });
        }

        try {
            let res;
            if (filters.length > 0) {
                // Use advanced search endpoint
                res = await fetch(`/search/advanced?page=${page}&per_page=${perPage}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filters })
                });
            } else {
                // Use basic search endpoint
                res = await fetch(`/search/title?q=${encodeURIComponent(q)}&page=${page}&per_page=${perPage}`);
            }

            const data = await res.json();
            if (data.error) throw new Error(data.error);

            const total = data.total || (Array.isArray(data) ? data.length : 0);

            // If total has increased, highlight the new count for a moment
            if (total > lastRefreshCount && lastRefreshCount > 0) {
                const badge = document.getElementById('total-count');
                badge.style.color = 'var(--success)';
                badge.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    badge.style.color = '';
                    badge.style.transform = '';
                }, 2000);
            }
            lastRefreshCount = total;

            if (Array.isArray(data)) {
                totalPages = 1;
                document.getElementById('total-count').innerText = data.length;
                renderResults(data);
            } else {
                // Calculate total pages
                const perPage = parseInt(document.getElementById('per-page-select').value);
                const total = data.total || 0;
                totalPages = Math.ceil(total / perPage);

                document.getElementById('total-count').innerText = total;
                renderResults(data.results || []);
            }
            renderPagination();
        } catch (e) {
            console.error('Search error:', e);
        }
    }

    // Move to Recon (Websites Tab)
    async function moveToRecon() {
        // Get current detailed item
        const urlElement = document.querySelector('.detail-value a');
        if (!urlElement) return;

        // Extract domain from URL or text
        let domain = urlElement.href.replace(/^https?:\/\//, '').split('/')[0];

        try {
            const res = await fetch('/subdomains/move_to_recon', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ domain: domain })
            });
            const data = await res.json();
            if (data.success) {
                alert('‚úÖ Moved to Websites Tab!');
                closeModal();
            } else {
                alert('‚ùå Failed: ' + data.error);
            }
        } catch (e) {
            alert('‚ùå Request Failed');
        }
    }

    function toggleSelectAll(checkbox) {
        const isChecked = checkbox.checked;
        const resultCheckboxes = document.querySelectorAll('.result-select');
        const cards = document.querySelectorAll('.result-card');

        cards.forEach((card, idx) => {
            const resultCheckbox = resultCheckboxes[idx];
            if (resultCheckbox.checked !== isChecked) {
                resultCheckbox.checked = isChecked;
                toggleSelect(idx, resultCheckbox);
            }
        });
    }

    // Render results
    function renderResults(results) {
        const container = document.getElementById('results-container');
        document.getElementById('select-all-checkbox').checked = false; // Reset on new render

        if (!results || !results.length) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 3rem;">No results found</div>';
            return;
        }

        container.innerHTML = results.map((r, idx) => {
            let data = {};
            let isIpScan = r._type === 'ip_scan' || (r.results && r.results.scan_summary);
            let isExtraction = r._type === 'extraction' || r.source === 'infra_scan' || (r.ip && r.port && r.title);
            let isSubdomainIntel = r._type === 'subdomain_intel' || (r.domain && r.primary_ip && r.http_intelligence);

            if (isIpScan) {
                // Handle IP Scan Schema
                const summary = r.results.scan_summary || {};
                const services = r.results.http_services || [];
                const firstService = services.length > 0 ? services[0] : {};
                const certs = r.results.ssl_certificates || [];
                const reverseDns = r.results.reverse_dns || {};

                // Extract CN and Hostname
                const commonName = certs.length > 0 ? certs[0].common_name : null;
                const hostname = reverseDns.hostname || null;

                // Prioritize Title -> CN -> Hostname -> 'IP Scan Result'
                let displayTitle = firstService.title;
                if (!displayTitle && commonName) displayTitle = `CN: ${commonName}`;
                if (!displayTitle && hostname) displayTitle = `DNS: ${hostname}`;
                if (!displayTitle) displayTitle = summary.hostnames ? summary.hostnames[0] : 'IP Scan Result';

                data = {
                    ip: r.ip,
                    port: summary.open_ports ? summary.open_ports.join(', ') : 'N/A',
                    title: displayTitle,
                    status_code: firstService.status_code || 200,
                    banner: summary.banner || firstService.server || 'N/A',
                    technologies: r.results.ip_intelligence ? r.results.ip_intelligence.technologies || [] : [],
                    waf: null,
                    domain: hostname,
                    common_name: commonName,
                    request: `http://${r.ip}`,
                    favicon_hash: null
                };
            } else if (isSubdomainIntel) {
                // Handle Subdomain Intelligence Schema (Phase 2 enhanced data)
                const httpIntel = r.http_intelligence || {};
                const techFp = r.technology_fingerprint || {};
                const cdnWaf = r.cdn_waf_enhanced || {};
                const endpoints = r.endpoints || {};
                
                // Extract technologies from multiple sources
                const techs = new Set();
                if (techFp.technologies) techFp.technologies.forEach(t => techs.add(t));
                if (r.technology_stack) Object.keys(r.technology_stack).forEach(t => techs.add(t));
                if (httpIntel.tech_indicators) Object.values(httpIntel.tech_indicators).forEach(t => {
                    if (Array.isArray(t)) t.forEach(x => techs.add(x));
                });
                
                // Extract WAF/CDN
                let wafTag = null;
                if (cdnWaf.waf_detection && cdnWaf.waf_detection.detected) {
                    wafTag = cdnWaf.waf_detection.detected[0];
                }
                
                data = {
                    ip: r.primary_ip || r.ip || 'N/A',
                    port: r.port || 80,
                    title: r.domain || 'Subdomain',
                    status_code: httpIntel.status_code || 200,
                    banner: httpIntel.server_header || (r.http_headers && r.http_headers.server) || 'N/A',
                    technologies: Array.from(techs),
                    waf: wafTag,
                    domain: r.domain,
                    common_name: r.ssl_certificate && r.ssl_certificate.common_name,
                    request: `https://${r.domain}`,
                    favicon_hash: null
                };
            } else if (isExtraction) {
                // Handle Extraction Result Schema (flat structure from domain scans)
                data = {
                    ip: r.ip || 'N/A',
                    port: r.port || 'N/A',
                    title: r.title || 'No Title',
                    status_code: r.status_code || 200,
                    banner: r.banner || r.server_banner || 'N/A',
                    technologies: r.technologies || [],
                    waf: r.waf || null,
                    domain: r.domain || null,
                    common_name: r.common_name || null,
                    request: r.request || `http://${r.ip}:${r.port}`,
                    favicon_hash: r.favicon_hash || null
                };
            } else {
                // Legacy handling for old schemas
                let resp = r.http_responseForIP || r.https_responseForIP ||
                    r.http_responseForDomainName || r.https_responseForDomainName;

                // Schema-Agnostic: if not nested, take the object itself
                if (!resp) resp = r;
                data = Array.isArray(resp) ? resp[0] || {} : resp;
            }

            const techTags = (data.technologies || [])
                .map(t => `<span class="tag tag-tech">${escapeHtml(t)}</span>`).join('');
            const wafTag = data.waf ? `<span class="tag tag-waf">WAF: ${escapeHtml(data.waf)}</span>` : '';
            const domainBadge = data.domain ? `<span class="domain-badge">${escapeHtml(data.domain)}</span>` : '';
            const cnBadge = data.common_name ? `<span class="tag" style="background: rgba(124, 58, 237, 0.2); color: var(--primary-light); border: 1px solid var(--primary-glow);">CN: ${escapeHtml(data.common_name)}</span>` : '';
            const bannerTag = data.banner ? `<span class="tag" style="background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success);">Reply: ${escapeHtml(data.banner.toString().substring(0, 20))}...</span>` : '';
            const safeTitle = escapeHtml(data.title || 'No Title');

            // Determine result object string for data-result attribute
            const resultStr = JSON.stringify(r).replace(/'/g, "&#39;").replace(/"/g, "&quot;");

            return `
            <div class="result-card" onclick="showDetail(${idx})" style="cursor: pointer; position: relative;" data-result='${resultStr}'>
                <input type="checkbox" class="result-select" onclick="event.stopPropagation(); toggleSelect(${idx}, this)" style="position: absolute; right: 1rem; top: 1rem; cursor: pointer;">
                <div class="result-title">
                    <span class="tag ${data.status_code >= 200 && data.status_code < 300 ? 'tag-tech' : (data.status_code >= 300 && data.status_code < 400 ? 'tag-waf' : 'tag-danger')}" style="margin-right: 0.5rem; border: 1px solid rgba(255,255,255,0.1)">
                        ${data.status_code || '???'}
                    </span>
                    ${safeTitle}
                    ${domainBadge}
                    ${cnBadge}
                    ${wafTag}
                    ${bannerTag}
                </div>
                <div style="margin-top: 0.25rem;">${techTags}</div>
                <div class="result-url"><a href="${escapeHtml(data.request)}" target="_blank" onclick="event.stopPropagation()" style="color: var(--primary); text-decoration: underline;">${escapeHtml(data.request || 'N/A')}</a></div>
                <div class="result-meta">
                    <div><strong>IP:</strong> <a href="http://${escapeHtml(data.ip)}" target="_blank" onclick="event.stopPropagation()" style="color: var(--primary); text-decoration: underline;">${escapeHtml(data.ip || 'N/A')}</a></div>
                    <div><strong>Port:</strong> ${escapeHtml(data.port || 'N/A')}</div>
                    <div style="grid-column: span 2;"><strong>TCP Banner:</strong> <span class="font-mono" style="color: var(--success);">${escapeHtml(data.banner || 'None')}</span></div>
                    <div><strong>Favicon:</strong> <span class="font-mono">${data.favicon_hash || 'N/A'}</span></div>
                </div>
            </div>
        `;
        }).join('');
    }

    // Render pagination
    function renderPagination() {
        const container = document.getElementById('pagination');

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';

        // Previous button
        html += `<button class="page-btn" onclick="performSearch(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê</button>`;

        // Page numbers
        const maxVisible = 7;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages, startPage + maxVisible - 1);

        if (endPage - startPage < maxVisible - 1) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }

        if (startPage > 1) {
            html += `<button class="page-btn" onclick="performSearch(1)">1</button>`;
            if (startPage > 2) html += `<span style="color: var(--text-muted);">...</span>`;
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="performSearch(${i})">${i}</button>`;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) html += `<span style="color: var(--text-muted);">...</span>`;
            html += `<button class="page-btn" onclick="performSearch(${totalPages})">${totalPages}</button>`;
        }

        // Next button
        html += `<button class="page-btn" onclick="performSearch(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>‚Üí</button>`;

        container.innerHTML = html;
    }

    // Filters
    function toggleFilters() {
        filtersVisible = !filtersVisible;
        document.getElementById('filters-panel').classList.toggle('hidden', !filtersVisible);
        if (filtersVisible && filterCount === 0) addFilter();
    }

    function addFilter() {
        filterCount++;
        const container = document.getElementById('filters-container');
        const row = document.createElement('div');
        row.className = 'filter-row';
        row.id = `filter-${filterCount}`;
        row.innerHTML = `
        <select class="filter-field">
            <option value="title">Title</option>
            <option value="ip">IP</option>
            <option value="domain">Domain</option>
            <option value="waf">WAF</option>
            <option value="technologies">Technology</option>
            <option value="port">Port</option>
            <option value="jarm_hash">JARM Hash</option>
            <option value="favicon_hash">Favicon Hash</option>
            <option value="status_code">Status Code</option>
        </select>
        <select class="filter-operator">
            <option value="contains">Contains</option>
            <option value="not_contains">Not Contains</option>
            <option value="equals">Equals</option>
            <option value="not_equals">Not Equals</option>
        </select>
        <input type="text" class="filter-value" placeholder="Value...">
        <button class="filter-remove" onclick="removeFilter(${filterCount})">√ó</button>
    `;
        container.appendChild(row);
    }

    function removeFilter(id) {
        const row = document.getElementById(`filter-${id}`);
        if (row) row.remove();
    }

    function clearFilters() {
        document.getElementById('search-input').value = '';
        document.getElementById('filters-container').innerHTML = '';
        filterCount = 0;
        document.getElementById('filters-panel').classList.add('hidden');
        filtersVisible = false;
        performSearch(1);
    }

    // Detail Modal
    function showDetail(idx) {
        document.getElementById('detail-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
        document.body.classList.add('modal-open');

        const cards = document.querySelectorAll('.result-card');
        const rawData = JSON.parse(cards[idx].dataset.result);

        let resultData = rawData;

        // Handle IP Scan Deep Schema (if it has 'results' and 'timestamp' from IPScanner)
        if (rawData.results && rawData.timestamp) {
            const scan = rawData.results;
            resultData = {
                ip: rawData.ip,
                asn: scan.asn_info?.asn || 'N/A',
                org: scan.asn_info?.organization || scan.asn_info?.isp || 'N/A',
                country: scan.asn_info?.country || 'N/A',
                title: scan.http_services?.[0]?.title || `IP Scan: ${rawData.ip}`,
                status_code: scan.http_services?.[0]?.status_code || 200,
                request: scan.http_services?.[0] ? `${scan.http_services[0].scheme}://${rawData.ip}:${scan.http_services[0].port}` : `http://${rawData.ip}`,
                banner: scan.open_ports?.[0]?.service || 'N/A',
                technologies: scan.http_services?.map(s => s.server).filter(Boolean) || [],
                whois: { raw: JSON.stringify(scan.asn_info, null, 2) },
                dns: { ptr: scan.reverse_dns?.hostname || 'N/A' },
                geolocation: scan.geolocation || {},
                _is_deep_scan: true,
                _raw_scan: scan
            };
        } else if (rawData.http_responseForIP || rawData.https_responseForIP) {
            // Extraction results normalization
            let resp = rawData.http_responseForIP || rawData.https_responseForIP;
            resultData = Array.isArray(resp) ? resp[0] || {} : resp;
            resultData.ip = resultData.ip || rawData.ip;
            resultData.port = resultData.port || rawData.port;
        }

        // Update subtitle
        document.getElementById('detail-subtitle').textContent = `IP: ${resultData.ip || 'N/A'} | Port: ${resultData.port || 'N/A'} | Status: ${resultData.status_code || 'Unknown'}`;

        let content = '';

        // --- Helper to render sections with better styling ---
        const renderSection = (title, icon, items) => {
            if (!items || items.length === 0) return '';
            return `
                <div class="detail-section">
                    <h3>${icon} ${title}</h3>
                    <div class="detail-grid">
                        ${items.map(i => `
                            <div class="detail-item">
                                <div class="label">${i.label}</div>
                                <div class="value">${i.value}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const renderCodeBlock = (title, icon, code) => {
            if (!code || code.includes('[!] Error') || code === 'N/A') return '';
            return `
                <div class="detail-section">
                    <h4>${icon} ${title}</h4>
                    <div class="code-block">${escapeHtml(code)}</div>
                </div>
            `;
        };

        // --- Data Extraction ---
        // Asset Info (Whois, ASN, etc.)
        const whois = resultData.whois || {};
        const assetItems = [
            { label: 'IP Address', value: resultData.ip || 'N/A' },
            { label: 'Port', value: resultData.port || 'N/A' },
            { label: 'TCP Banner', value: `<span style="color:#22c55e; font-family:monospace;">${escapeHtml(resultData.banner || 'None')}</span>` },
            { label: 'ASN', value: resultData.asn || 'N/A' },
            { label: 'Organization', value: resultData.org || whois.organization || 'N/A' },
            { label: 'Country', value: resultData.country || 'N/A' },
            { label: 'Netblock', value: whois.netblock || 'N/A' },
            { label: 'Owner', value: whois.owner || 'N/A' }
        ];

        // Web Info
        const webItems = [
            { label: 'Domain (SSL CN)', value: resultData.domain || 'N/A' },
            { label: 'Page Title', value: resultData.title || 'No Title' },
            { label: 'Status Code', value: resultData.status_code || '---' },
            { label: 'Request URL', value: `<a href="${resultData.request}" target="_blank" style="color: #60a5fa; text-decoration: underline;">${resultData.request || 'N/A'}</a>` }
        ];

        // DNS Info
        const dns = resultData.dns || {};
        const dnsItems = [
            { label: 'PTR Record', value: dns.ptr || 'N/A' }
        ];

        // Exposure Indicators
        const exposureHtml = (resultData.exposures || []).length > 0 ? `
            <div class="detail-section" style="border-left: 4px solid #ef4444; background: rgba(239, 68, 68, 0.08);">
                <h3 style="color: #ef4444; margin-top: 0;">üö® Critical Exposures Detected</h3>
                <ul style="margin: 0; padding-left: 1.5rem; color: #e5e7eb; line-height: 1.8;">
                    ${resultData.exposures.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
                </ul>
            </div>
        ` : '';

        // --- Build Final Content ---
        content += exposureHtml;
        content += renderSection('üåç Asset Intelligence', '', assetItems);
        content += renderSection('üåê Web Service Details', '', webItems);
        content += renderSection('üß¨ DNS Intelligence', '', dnsItems);

        if (resultData.technologies && resultData.technologies.length > 0) {
            content += `
                <div class="detail-section">
                    <h4>üîß Detected Technology Stack</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${resultData.technologies.map(t => `<span class="tech-tag">${escapeHtml(t)}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        content += renderCodeBlock('üõ∞Ô∏è Nmap Service Scan', '', resultData.nmap?.raw);
        content += renderCodeBlock('üîê SSL/TLS Detail', '', resultData.ssl_raw);
        content += renderCodeBlock('üìã Whois Raw Output', '', resultData.whois?.raw);
        content += renderCodeBlock('üîç DNS Output (Nslookup)', '', resultData.dns?.nslookup);

        if (resultData._is_deep_scan) {
            const scan = resultData._raw_scan;

            // Render Ports Table
            if (scan.open_ports && scan.open_ports.length > 0) {
                content += `
                    <div class="detail-section">
                        <h3>üîå Open Ports & Services</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <thead>
                                <tr style="text-align: left; border-bottom: 1px solid rgba(59, 130, 246, 0.3);">
                                    <th style="padding: 0.5rem;">Port</th>
                                    <th style="padding: 0.5rem;">Protocol</th>
                                    <th style="padding: 0.5rem;">Service</th>
                                    <th style="padding: 0.5rem;">State</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${scan.open_ports.map(p => `
                                    <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                                        <td style="padding: 0.5rem; color: #60a5fa; font-weight: bold;">${p.port}</td>
                                        <td style="padding: 0.5rem;">${p.protocol}</td>
                                        <td style="padding: 0.5rem;">${escapeHtml(p.service)}</td>
                                        <td style="padding: 0.5rem;"><span class="tag tag-tech">${p.state}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // Render HTTP Services
            if (scan.http_services && scan.http_services.length > 0) {
                content += `
                    <div class="detail-section">
                        <h3>üåê HTTP Services</h3>
                        ${scan.http_services.map(s => `
                            <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <span style="font-weight: bold; color: #60a5fa;">${s.scheme.toUpperCase()} on Port ${s.port}</span>
                                    <span class="tag ${s.status_code >= 200 && s.status_code < 300 ? 'tag-tech' : 'tag-danger'}">${s.status_code}</span>
                                </div>
                                <div style="margin-bottom: 0.5rem;"><strong>Title:</strong> ${escapeHtml(s.title || 'No Title')}</div>
                                <div style="margin-bottom: 0.5rem;"><strong>Server:</strong> ${escapeHtml(s.server || 'Unknown')}</div>
                                <div class="code-block" style="font-size: 0.7rem;">${escapeHtml(JSON.stringify(s.headers, null, 2))}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        if (!content) content = '<div style="text-align: center; color: var(--text-muted);">No response data</div>';

        document.getElementById('detail-content').innerHTML = content;
        document.getElementById('detail-actions').style.display = 'flex';
        document.getElementById('detail-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    function startFuzz() {
        const urlElement = document.querySelector('.detail-value a');
        if (!urlElement) {
            alert('Could not determine target URL.');
            return;
        }
        const target = urlElement.href;
        selectedTargets.add(target);
        updateFuzzButton();
        fuzzSelected();
        closeModal();
    }

    function closeModal() {
        document.getElementById('detail-modal').classList.remove('active');
        document.getElementById('modal-overlay').classList.remove('active');
        document.body.classList.remove('modal-open');
    }

    // Export
    async function exportResults() {
        const filename = prompt('Enter filename (e.g. results.json):');
        if (!filename) return;
        try {
            await fetch('/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename })
            });
            alert('Export complete!');
        } catch (e) {
            alert('Export failed: ' + e);
        }
    }

    function toggleAutoRefresh(checkbox) {
        if (checkbox.checked) {
            refreshInterval = setInterval(() => {
                // Only auto-refresh if we are on the first page and no specific search query or if it's explicitly allowed
                const q = document.getElementById('search-input').value;
                if (!q && currentPage === 1) {
                    performSearch(1);
                }
            }, 5000);
        } else {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    // Initialize
    // Load IP results if available, otherwise load from search
    if (!loadIPScanResults()) {
        performSearch(1);
    }

    // Check if there's IP scan data in sessionStorage
    function loadIPScanResults() {
        const ipScanData = sessionStorage.getItem('latest_ip_scan');
        const urlParams = new URLSearchParams(window.location.search);
        const ipParam = urlParams.get('ip');

        if (ipScanData && urlParams.get('type') === 'ip' && ipParam) {
            try {
                const scanResults = JSON.parse(ipScanData);

                if (scanResults) {
                    // Transform IP scan results into result card format
                    const formattedResult = {
                        ip: ipParam,
                        port: scanResults.ports_scanned || 'N/A',
                        status_code: 200,
                        title: `IP Scan: ${ipParam}`,
                        request: `http://${ipParam}`,
                        banner: scanResults.scan_summary?.open_ports_count > 0 ? 'Active' : 'No open ports',
                        asn: scanResults.asn_info?.asn || 'N/A',
                        org: scanResults.asn_info?.organization || 'N/A',
                        country: scanResults.geolocation?.country || 'N/A',
                        whois: scanResults.asn_info || {},
                        dns: scanResults.reverse_dns || {},
                        domain: scanResults.reverse_dns?.hostname || 'N/A',
                        technologies: scanResults.http_services?.map(s => s.server).filter(Boolean) || [],
                        exposures: [],
                        results: scanResults, // Keep raw results for showDetail
                        timestamp: new Date().toISOString()
                    };

                    // Display the results
                    renderResults([formattedResult]);
                    document.getElementById('total-count').innerText = '1';

                    // Clear sessionStorage so fresh search works on next visit
                    sessionStorage.removeItem('latest_ip_scan');
                    return true;
                }
            } catch (e) {
                console.error('Error loading IP scan results:', e);
            }
        }
        return false;
    }

    // Enter key for search
    document.getElementById('search-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch(1);
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('detail-modal').classList.contains('active')) {
            closeModal();
        }
    });

    document.getElementById('modal-overlay').addEventListener('click', closeModal);
</script>
{% endblock %}