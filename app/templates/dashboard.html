{% extends "base.html" %}

{% block title %}Dashboard - Ri-Scanner Pro{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 350px 1fr; gap: 2rem;">
    <!-- Sidebar / Stats -->
    <aside class="glass card" style="height: fit-content; position: sticky; top: 100px;">
        <h3 style="margin-top: 0; margin-bottom: 1rem;">Scan Status</h3>

        <!-- Phase Badge -->
        <div id="phase-badge" class="phase-badge idle">Idle</div>

        <!-- Masscan Progress -->
        <div class="progress-container">
            <div class="progress-header">
                <span>Masscan</span>
                <span id="masscan-txt" style="font-weight: 600;">0%</span>
            </div>
            <div class="progress-bar">
                <div id="masscan-bar" class="progress-fill" style="width: 0%;"></div>
            </div>
            <div class="flex-between mt-sm" style="font-size: 0.75rem; color: var(--text-muted);">
                <span id="masscan-ranges">Ranges: 0 / 0</span>
                <span id="masscan-eta">ETA: --</span>
            </div>
        </div>

        <!-- Active Chunks Section -->
        <div style="margin: 1rem 0;">
            <div class="flex-between" style="margin-bottom: 0.5rem;">
                <span style="font-size: 0.85rem; font-weight: 600;">Active Chunks</span>
                <span id="active-chunk-count" style="font-size: 0.75rem; color: var(--text-muted);">0 running</span>
            </div>
            <div id="chunk-list" style="max-height: 250px; overflow-y: auto;">
                <div style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.85rem;">
                    No active chunks
                </div>
            </div>
        </div>

        <!-- Extraction Progress -->
        <div class="progress-container">
            <div class="progress-header">
                <span>Extraction</span>
                <span id="extract-txt">0%</span>
            </div>
            <div class="progress-bar">
                <div id="extract-bar" class="progress-fill blue" style="width: 0%;"></div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stat-grid mt-md">
            <div class="stat-card">
                <div id="found-count" class="stat-value">0</div>
                <div class="stat-label">Results</div>
            </div>
            <div class="stat-card">
                <div id="active-threads" class="stat-value">0</div>
                <div class="stat-label">Threads</div>
            </div>
        </div>

        <!-- Stop Button -->
        <button onclick="showStopModal()" class="btn btn-danger btn-full mt-lg">Stop Scan</button>
    </aside>

    <!-- Main Content - Logs -->
    <div class="glass card" style="padding: 0; height: 600px; display: flex; flex-direction: column;">
        <div style="padding: 1rem; border-bottom: 1px solid var(--glass-border);">
            <h3 style="margin: 0;">Live Logs</h3>
        </div>
        <div id="log-container" class="log-container" style="flex: 1;">
            <div class="log-entry">Initializing dashboard...</div>
        </div>
    </div>
</div>

<!-- Stop Modal -->
<div id="modal-overlay" class="modal-overlay"></div>
<div id="stop-modal" class="glass modal">
    <h3 class="modal-title">Stop Scan?</h3>
    <p class="modal-body">Do you want to keep the collected data files?</p>
    <div class="modal-actions">
        <button onclick="confirmStop(true)" class="btn btn-success">Keep Data</button>
        <button onclick="confirmStop(false)" class="btn btn-danger">Delete Data</button>
    </div>
    <button onclick="closeModal()" class="btn btn-outline btn-full mt-md">Cancel</button>
</div>
{% endblock %}

{% block scripts %}
<style>
    .chunk-item {
        background: rgba(16, 185, 129, 0.15);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: var(--radius-sm);
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .chunk-item:hover {
        background: rgba(16, 185, 129, 0.25);
        border-color: rgba(16, 185, 129, 0.5);
    }

    .chunk-item.expanded {
        background: rgba(16, 185, 129, 0.2);
    }

    .chunk-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chunk-id {
        font-weight: 600;
        color: var(--success);
        font-size: 0.9rem;
    }

    .chunk-status {
        font-size: 0.7rem;
        text-transform: uppercase;
        padding: 2px 6px;
        border-radius: 4px;
        background: var(--success);
        color: white;
        animation: pulse 1.5s ease-in-out infinite;
    }

    .chunk-details {
        display: none;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.8rem;
    }

    .chunk-item.expanded .chunk-details {
        display: block;
    }

    .chunk-detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.25rem;
        color: var(--text-secondary);
    }

    .chunk-detail-row span:last-child {
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
    }

    .chunk-progress {
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
    }

    .chunk-progress-fill {
        height: 100%;
        background: var(--success);
        transition: width 0.3s ease;
    }
</style>

<script>
    let logInterval, statusInterval;
    let lastLogCount = 0;
    let expandedChunks = new Set();

    // Status updates
    async function updateStatus() {
        try {
            const res = await fetch('/get_status');
            const data = await res.json();

            // Phase badge
            const badge = document.getElementById('phase-badge');
            badge.innerText = data.phase;
            badge.className = 'phase-badge';
            if (data.phase.includes('Masscan')) badge.classList.add('scanning');
            else if (data.phase.includes('Extraction')) badge.classList.add('extracting');
            else if (data.phase === 'Idle') badge.classList.add('idle');

            // Masscan progress
            const mPct = data.masscan_total > 0 ? (data.masscan_progress / data.masscan_total * 100) : 0;
            document.getElementById('masscan-bar').style.width = `${mPct}%`;
            document.getElementById('masscan-txt').innerText = `${Math.round(mPct)}%`;

            // Ranges & ETA
            document.getElementById('masscan-ranges').innerText =
                `Ranges: ${data.masscan_ranges_done || 0} / ${data.masscan_ranges_total || 0}`;
            document.getElementById('masscan-eta').innerText =
                `ETA: ${data.estimated_remaining || '--'}`;

            // Active Chunks - Filter only running chunks
            renderActiveChunks(data.masscan_chunks_status || []);

            // Extraction progress
            const ePct = data.extraction_total > 0 ? (data.extraction_progress / data.extraction_total * 100) : 0;
            document.getElementById('extract-bar').style.width = `${ePct}%`;
            document.getElementById('extract-txt').innerText = `${Math.round(ePct)}%`;

            // Stats
            document.getElementById('found-count').innerText = data.found_count || 0;
            document.getElementById('active-threads').innerText = data.active_threads || 0;

        } catch (e) {
            console.error('Status update error:', e);
        }
    }

    function renderActiveChunks(chunks) {
        // Filter only running chunks (not completed, not pending)
        const activeChunks = chunks.filter(c => c.status === 'running');

        document.getElementById('active-chunk-count').innerText = `${activeChunks.length} running`;

        const container = document.getElementById('chunk-list');

        if (activeChunks.length === 0) {
            const hasCompleted = chunks.some(c => c.status === 'completed');
            container.innerHTML = `
            <div style="text-align: center; color: var(--text-muted); padding: 1rem; font-size: 0.85rem;">
                ${hasCompleted ? 'All chunks completed!' : 'Waiting for chunks...'}
            </div>
        `;
            return;
        }

        container.innerHTML = activeChunks.map(chunk => {
            const isExpanded = expandedChunks.has(chunk.id);
            const progressPct = chunk.total > 0 ? (chunk.processed / chunk.total * 100) : 0;

            return `
            <div class="chunk-item ${isExpanded ? 'expanded' : ''}" onclick="toggleChunk(${chunk.id})">
                <div class="chunk-header">
                    <span class="chunk-id">Chunk #${chunk.id + 1}</span>
                    <span class="chunk-status">Running</span>
                </div>
                <div class="chunk-details">
                    <div class="chunk-detail-row">
                        <span>First Range:</span>
                        <span>${chunk.first_range || 'N/A'}</span>
                    </div>
                    <div class="chunk-detail-row">
                        <span>Last Range:</span>
                        <span>${chunk.last_range || 'N/A'}</span>
                    </div>
                    <div class="chunk-detail-row">
                        <span>Total Ranges:</span>
                        <span>${chunk.total || 0}</span>
                    </div>
                    <div class="chunk-detail-row">
                        <span>Processed:</span>
                        <span>${chunk.processed || 0}</span>
                    </div>
                    <div class="chunk-detail-row">
                        <span>Remaining:</span>
                        <span>${Math.max(0, (chunk.total || 0) - (chunk.processed || 0))}</span>
                    </div>
                    <div class="chunk-progress">
                        <div class="chunk-progress-fill" style="width: ${progressPct}%;"></div>
                    </div>
                </div>
            </div>
        `;
        }).join('');
    }

    function toggleChunk(id) {
        if (expandedChunks.has(id)) {
            expandedChunks.delete(id);
        } else {
            expandedChunks.add(id);
        }
    }

    // Log fetching
    async function fetchLogs() {
        try {
            const res = await fetch('/get_logs');
            const logs = await res.json();

            if (logs.length !== lastLogCount) {
                const container = document.getElementById('log-container');
                container.innerHTML = logs.map(l => {
                    let className = 'log-entry';
                    if (l.includes('FOUND:')) className += ' found';
                    else if (l.includes('[!]')) className += ' error';
                    return `<div class="${className}">> ${l}</div>`;
                }).join('');
                container.scrollTop = container.scrollHeight;
                lastLogCount = logs.length;
            }
        } catch (e) { }
    }

    // Modal functions
    function showStopModal() {
        document.getElementById('stop-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal() {
        document.getElementById('stop-modal').classList.remove('active');
        document.getElementById('modal-overlay').classList.remove('active');
    }

    async function confirmStop(keepData) {
        closeModal();
        document.getElementById('phase-badge').innerText = 'Terminating...';

        try {
            await fetch('/stop_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ save: keepData })
            });
        } catch (e) {
            console.error('Stop error:', e);
        }
    }

    // Initialize
    statusInterval = setInterval(updateStatus, 1000);
    logInterval = setInterval(fetchLogs, 1500);
    updateStatus();
    fetchLogs();

    document.getElementById('modal-overlay').addEventListener('click', closeModal);
</script>
{% endblock %}