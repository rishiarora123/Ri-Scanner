{% extends "base.html" %}

{% block title %}Dashboard - Ri-Scanner Pro{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 350px 1fr; gap: 2rem;">
    <!-- Sidebar / Stats -->
    <aside class="glass card" style="height: fit-content; position: sticky; top: 100px;">
        <h3 style="margin-top: 0; margin-bottom: 1rem;">Scan Status</h3>

        <!-- Phase Badge -->
        <div id="phase-badge" class="phase-badge idle">Idle</div>

        <!-- Masscan Progress -->
        <div class="progress-container">
            <div class="progress-header">
                <span style="display: flex; align-items: center; gap: 0.5rem;">üì° Masscan</span>
                <span id="masscan-txt" style="font-weight: 600;">0%</span>
            </div>
            <div class="progress-bar">
                <div id="masscan-bar" class="progress-fill" style="width: 0%;"></div>
            </div>
            <div class="flex-between mt-sm" style="font-size: 0.75rem; color: var(--text-muted);">
                <span id="masscan-ranges">Chunks: 0 / 0</span>
                <span id="masscan-eta">ETA: --</span>
            </div>
        </div>

        <!-- Naabu Progress -->
        <div class="progress-container">
            <div class="progress-header">
                <span style="display: flex; align-items: center; gap: 0.5rem;">üõ∞Ô∏è Naabu</span>
                <span id="naabu-txt" style="font-weight: 600;">0%</span>
            </div>
            <div class="progress-bar">
                <div id="naabu-bar" class="progress-fill blue" style="width: 0%;"></div>
            </div>
            <div class="flex-between mt-sm" style="font-size: 0.75rem; color: var(--text-muted);">
                <span id="naabu-status">Waiting...</span>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="stat-grid mt-md">
            <div class="stat-card">
                <div id="found-count" class="stat-value">0</div>
                <div class="stat-label">Results</div>
            </div>
            <div class="stat-card">
                <div id="active-threads" class="stat-value">0</div>
                <div class="stat-label">Threads</div>
            </div>
        </div>

        <!-- Stop Button -->
        <button onclick="showStopModal()" class="btn btn-danger btn-full mt-md">üõë Stop All</button>
    </aside>

    <!-- Main Content - Logs -->
    <div class="glass card" style="padding: 0; height: 600px; display: flex; flex-direction: column;">
        <div style="padding: 1rem; border-bottom: 1px solid var(--glass-border);">
            <h3 style="margin: 0;">Live Logs</h3>
        </div>
        <div id="log-container" class="log-container" style="flex: 1;">
            <div class="log-entry">Initializing dashboard...</div>
        </div>
    </div>
</div>

<!-- Stop Modal -->
<div id="modal-overlay" class="modal-overlay"></div>
<div id="stop-modal" class="glass modal">
    <h3 class="modal-title">Stop Scan?</h3>
    <p class="modal-body">Do you want to keep the collected data files?</p>
    <div class="modal-actions">
        <button onclick="confirmStop(true)" class="btn btn-success">Keep Data</button>
        <button onclick="confirmStop(false)" class="btn btn-danger">Delete Data</button>
    </div>
    <button onclick="closeModal()" class="btn btn-outline btn-full mt-md">Cancel</button>
</div>
{% endblock %}

{% block scripts %}
<style>
    #chunk-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(24px, 1fr));
        gap: 6px;
        margin-top: 1rem;
    }

    .chunk-cube {
        width: 24px;
        height: 24px;
        background: rgba(16, 185, 129, 0.2);
        border: 1px solid rgba(16, 185, 129, 0.4);
        border-radius: 4px;
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
    }

    .chunk-cube:hover {
        background: var(--success);
        transform: scale(1.1);
        z-index: 10;
    }

    .chunk-cube.running {
        background: var(--success);
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        animation: pulse 2s infinite;
    }

    .chunk-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        margin-bottom: 5px;
        border: 1px solid var(--glass-border);
        z-index: 100;
    }

    .chunk-cube:hover .chunk-tooltip {
        opacity: 1;
    }

    .chunk-detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.25rem;
        color: var(--text-secondary);
    }

    .chunk-detail-row span:last-child {
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
    }

    .chunk-progress {
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
    }

    .chunk-progress-fill {
        height: 100%;
        background: var(--success);
        transition: width 0.3s ease;
    }
</style>

<script>
    let logInterval, statusInterval;
    let lastLogCount = 0;
    let expandedChunks = new Set();

    // Status updates
    async function updateStatus() {
        try {
            const res = await fetch('/get_status');
            const data = await res.json();

            // Phase badge
            const badge = document.getElementById('phase-badge');
            badge.innerText = data.phase;
            badge.className = 'phase-badge';
            if (data.phase.includes('Masscan')) badge.classList.add('scanning');
            else if (data.phase.includes('Naabu')) badge.classList.add('extracting');
            else if (data.phase === 'Idle') badge.classList.add('idle');

            // Masscan progress
            const mPct = data.masscan_total > 0 ? (data.masscan_progress / data.masscan_total * 100) : 0;
            document.getElementById('masscan-bar').style.width = `${mPct}%`;
            document.getElementById('masscan-txt').innerText = `${Math.round(mPct)}%`;

            // Masscan Chunks & ETA
            document.getElementById('masscan-ranges').innerText =
                `Chunks: ${data.masscan_ranges_done || 0} / ${data.masscan_ranges_total || 0}`;
            document.getElementById('masscan-eta').innerText =
                `ETA: ${data.estimated_remaining || '--'}`;

            // Naabu progress
            const nPct = data.naabu_total > 0 ? (data.naabu_progress / data.naabu_total * 100) : 0;
            document.getElementById('naabu-bar').style.width = `${nPct}%`;
            document.getElementById('naabu-txt').innerText = `${Math.round(nPct)}%`;

            // Naabu status
            const nStatus = document.getElementById('naabu-status');
            if (nPct > 0 && nPct < 100) {
                nStatus.innerText = `Scanning: ${data.naabu_progress} / ${data.naabu_total} chunks`;
            } else if (nPct === 100) {
                nStatus.innerText = "Completed";
            } else {
                nStatus.innerText = data.phase.includes('Naabu') ? "Running..." : "Waiting...";
            }

            // Stats
            document.getElementById('found-count').innerText = data.found_count || 0;
            document.getElementById('active-threads').innerText = data.active_threads || 0;

        } catch (e) {
            console.error('Status update error:', e);
        }
    }

    function toggleChunk(id) {
        if (expandedChunks.has(id)) {
            expandedChunks.delete(id);
        } else {
            expandedChunks.add(id);
        }
    }

    // Log fetching
    async function fetchLogs() {
        try {
            const res = await fetch('/get_logs');
            const logs = await res.json();

            if (logs.length !== lastLogCount) {
                const container = document.getElementById('log-container');
                container.innerHTML = logs.map(l => {
                    let className = 'log-entry';
                    if (l.includes('FOUND:')) className += ' found';
                    else if (l.includes('[!]')) className += ' error';
                    return `<div class="${className}">> ${l}</div>`;
                }).join('');
                container.scrollTop = container.scrollHeight;
                lastLogCount = logs.length;
            }
        } catch (e) { }
    }

    // Modal functions
    function showStopModal() {
        document.getElementById('stop-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal() {
        document.getElementById('stop-modal').classList.remove('active');
        document.getElementById('modal-overlay').classList.remove('active');
    }

    async function confirmStop(keepData) {
        closeModal();
        document.getElementById('phase-badge').innerText = 'Terminating...';

        try {
            await fetch('/stop_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ save: keepData })
            });
        } catch (e) {
            console.error('Stop error:', e);
        }
    }

    // Modal functions
    function showStopModal() {
        document.getElementById('stop-modal').classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }

    function closeModal() {
        document.getElementById('stop-modal').classList.remove('active');
        document.getElementById('modal-overlay').classList.remove('active');
    }

    async function confirmStop(keepData) {
        closeModal();
        document.getElementById('phase-badge').innerText = 'Terminating...';

        try {
            await fetch('/stop_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ save: keepData })
            });
        } catch (e) {
            console.error('Stop error:', e);
        }
    }

    // Initialize
    statusInterval = setInterval(updateStatus, 1000);
    logInterval = setInterval(fetchLogs, 1500);
    updateStatus();
    fetchLogs();

    document.getElementById('modal-overlay').addEventListener('click', closeModal);
</script>
{% endblock %}